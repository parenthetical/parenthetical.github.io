<!DOCTYPE html>
<html lang="en">
  	<head>
		<meta charset="utf-8"/>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="generator" content="Hugo 0.120.3">
		<title>A short FRP implementation in Haskell (with comments) - Adriaan Leijnse</title>

		<meta name="description" content="Audience: This post is for meant for people familiar with Haskell, Classic style Functional Reactive Programming, and Reflex FRP in particular.
I&rsquo;ve been dissecting Reflex&rsquo; Spider implementation and I&rsquo;ve started to implement an FRP library from scratch to test what I&rsquo;ve learned. I&rsquo;ve tried to add lots of comments so that it is educational for anyone wanting to explore FRP implementations.
Hopefully I&rsquo;ll keep expanding it with more features and optimizations, but so far it uses the most basic implementation I could think of:">


		
	
		




<link rel="stylesheet" href="/css/ui.css">

	
		

		<link  rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Mono|Lato|Raleway">

		
	</head>

  <body>
    <header class="container no-print">
      <nav id="navbar"
           style="
                  margin-bottom: 3rem;
                  padding-top: 1rem;
                  display: flex;
                  flex-wrap: wrap;
                  align-items: flex-end;
                  column-gap: 1.7rem;
                  "             >
        <a href="/"
           >
          <h1 style="
                     margin: 0.2rem 0;
                     padding: 0;
                     font-size: 1.6rem;
                     font-family: roman;
                     color: #777;
                     ">
            Adriaan Leijnse
          </h1>
        </a>
        <ul>
          <li>
            <a href="/blog/"
               
               class="active"
               
               >
              Blog
            </a>
          </li><li>
            <a href="/foc-ideas/"
               
               >
              Future of Coding
            </a>
          </li><li>
            <a href="/journal/"
               
               >
              Journal
            </a>
          </li><li>
            <a href="/papers/"
               
               >
              Papers
            </a>
          </li></ul>
      </nav>
    </header>
    <main class="container">

<article>
	<header><hgroup id="brand">
	<h1>A short FRP implementation in Haskell (with comments)</h1>
        
	<h5>
	  
          
	    <time datetime="2024-01-17 00:00:00 &#43;0000 UTC">Jan 17, 2024</time>
          
		<span class="no-print">
			<span>
	</h5>
	
</hgroup>
<hr class="sep" />
</header>
	<div class="preface">
<p>Audience: This post is for meant for people familiar with Haskell, Classic style Functional Reactive Programming, and Reflex FRP in particular.</p>
</div>
<p>I&rsquo;ve been dissecting Reflex&rsquo; <a href="https://github.com/reflex-frp/reflex/blob/b7d933a33a72949a700414bda7a23aa90105431a/src/Reflex/Spider/Internal.hs">Spider</a> implementation and I&rsquo;ve started to implement an <a href="https://github.com/parenthetical/frp-journey/tree/simple-frp-implementation-1">FRP library</a> from scratch to test what I&rsquo;ve learned.
I&rsquo;ve tried to add lots of comments so that it is educational for anyone wanting to explore FRP implementations.</p>
<p>Hopefully I&rsquo;ll keep expanding it with more features and optimizations, but so far it uses the most basic implementation I could think of:</p>
<ul>
<li>A graph traversal which visits every event, even though there is no occurrence</li>
<li>No garbage collection</li>
<li>No optimizations like Reflex&rsquo; incremental merging and <code>fan</code> functions</li>
</ul>
<p>It&rsquo;s up on GitHub in a <a href="https://github.com/parenthetical/frp-journey/tree/simple-frp-implementation-1">branch for this blog post</a> and I&rsquo;ve copied the modules below as well for reference.</p>
<h2 id="extra-laziness-by-default">Extra laziness by default</h2>
<p>Despite the current limitations I&rsquo;ve made sure that it is lazy enough to express all of Reflex and that it would pass its test suite&mdash;it&rsquo;s actually more lazy in the default sampling function for behaviors than Reflex.
In short, Reflex has the <code>build*</code>-family of <code>hold</code> functions which allow you to forward reference and sample a behavior &ldquo;before it is defined&rdquo;.
Achieving this requires delaying a sample (which in essence is going to be reading an <code>IORef</code>) via <code>unsafePerformIO</code> for example.
I think this is due to limitations in how GHC&rsquo;s <code>fixIO</code> works.
The problem then is that the value has to be force evaluated before the behavior changes, otherwise you&rsquo;ll be reading some newer value while it should have evaluated to an older value.
This forcing is done by adding it to one of the queues of the main loop, and at the latest has to be done before the behavior&rsquo;s <code>IORef</code> is updated.</p>
<p>In my implementation I&rsquo;ve made this way of sampling the default (see <code>holdSampleStrictness</code> in the tests module below). Unfortunately this might be inefficient enough to cause performance problems in real world applications.
On the other hand, not having it and having to predict when extra laziness for forward referencing is needed is going to break composition and high-level abstractions, as I&rsquo;ve experienced myself plenty of times while trying to add distributed programming and other &ldquo;out there&rdquo; ideas to Reflex :')</p>
<p>Issues like these have pushed me towards thinking that an FRP interface which is both expressive and simple is not feasible without proper compiler support and that it would be hard to push the boundaries of FRP as plain Haskell libraries.</p>
<h2 id="library-modules">Library modules</h2>
<p>Like in Reflex I&rsquo;ve split up the library in an <a href="https://github.com/parenthetical/frp-journey/blob/simple-frp-implementation-1/src/Frp/Class.hs">interface</a>, an <a href="https://github.com/parenthetical/frp-journey/blob/simple-frp-implementation-1/src/Frp/Pure.hs">executable and simple semantics</a>, and an <a href="https://github.com/parenthetical/frp-journey/blob/simple-frp-implementation-1/src/Frp/Impl.hs">imperative implementation</a>.
I also added a <a href="https://github.com/parenthetical/frp-journey/blob/simple-frp-implementation-1/src/Frp/Test.hs">test suite</a> by adapting much of Reflex&rsquo; <code>semantics</code> tests.</p>
<h3 id="interface">Interface</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="cm">{-# LANGUAGE ApplicativeDo #-}</span>
</span></span><span class="line"><span class="cl"><span class="cm">{-# LANGUAGE TypeFamilies #-}</span>
</span></span><span class="line"><span class="cl"><span class="cm">{-# LANGUAGE RecursiveDo #-}</span>
</span></span><span class="line"><span class="cl"><span class="cm">{-# LANGUAGE RankNTypes #-}</span>
</span></span><span class="line"><span class="cl"><span class="cm">{-|
</span></span></span><span class="line"><span class="cl"><span class="cm">Description: FRP interface definition and utility functions.
</span></span></span><span class="line"><span class="cl"><span class="cm">-}</span>
</span></span><span class="line"><span class="cl"><span class="kr">module</span> <span class="nn">Frp.Class</span> <span class="kr">where</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Control.Monad.Fix</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.Kind</span> <span class="p">(</span><span class="kt">Type</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.These</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.Semigroup</span> <span class="p">(</span><span class="kt">Semigroup</span><span class="p">(</span><span class="o">..</span><span class="p">),</span><span class="kt">First</span><span class="p">(</span><span class="o">..</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.List.NonEmpty</span> <span class="p">(</span><span class="nf">nonEmpty</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Data.Map</span> <span class="k">as</span> <span class="n">Map</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.Map</span> <span class="p">(</span><span class="kt">Map</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Witherable</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Prelude</span> <span class="k">hiding</span> <span class="p">(</span><span class="nf">filter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.These.Combinators</span> <span class="p">(</span><span class="nf">justThis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.Align</span> <span class="p">(</span><span class="kt">Semialign</span><span class="p">(</span><span class="o">..</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">class</span> <span class="p">(</span><span class="kt">MonadFix</span> <span class="p">(</span><span class="kt">Behavior</span> <span class="n">t</span><span class="p">),</span> <span class="kt">MonadFix</span> <span class="p">(</span><span class="kt">Moment</span> <span class="n">t</span><span class="p">))</span> <span class="ow">=&gt;</span> <span class="kt">Frp</span> <span class="p">(</span><span class="n">t</span> <span class="ow">::</span> <span class="kt">Type</span><span class="p">)</span> <span class="kr">where</span>
</span></span><span class="line"><span class="cl">  <span class="kr">data</span> <span class="kt">Behavior</span> <span class="n">t</span> <span class="ow">::</span> <span class="kt">Type</span> <span class="ow">-&gt;</span> <span class="kt">Type</span>
</span></span><span class="line"><span class="cl">  <span class="kr">data</span> <span class="kt">Event</span> <span class="n">t</span> <span class="ow">::</span> <span class="kt">Type</span> <span class="ow">-&gt;</span> <span class="kt">Type</span>
</span></span><span class="line"><span class="cl">  <span class="kr">type</span> <span class="kt">Moment</span> <span class="n">t</span> <span class="ow">::</span> <span class="kt">Type</span> <span class="ow">-&gt;</span> <span class="kt">Type</span>
</span></span><span class="line"><span class="cl">  <span class="n">mapMaybeMoment</span> <span class="ow">::</span> <span class="p">(</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Moment</span> <span class="n">t</span> <span class="p">(</span><span class="kt">Maybe</span> <span class="n">b</span><span class="p">))</span> <span class="ow">-&gt;</span> <span class="kt">Event</span> <span class="n">t</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Event</span> <span class="n">t</span> <span class="n">b</span>
</span></span><span class="line"><span class="cl">  <span class="n">coincidence</span> <span class="ow">::</span> <span class="kt">Event</span> <span class="n">t</span> <span class="p">(</span><span class="kt">Event</span> <span class="n">t</span> <span class="n">a</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">Event</span> <span class="n">t</span> <span class="n">a</span>
</span></span><span class="line"><span class="cl">  <span class="n">merge</span> <span class="ow">::</span> <span class="kt">Event</span> <span class="n">t</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Event</span> <span class="n">t</span> <span class="n">b</span> <span class="ow">-&gt;</span> <span class="kt">Event</span> <span class="n">t</span> <span class="p">(</span><span class="kt">These</span> <span class="n">a</span> <span class="n">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">never</span> <span class="ow">::</span> <span class="kt">Event</span> <span class="n">t</span> <span class="n">a</span>
</span></span><span class="line"><span class="cl">  <span class="n">switch</span> <span class="ow">::</span> <span class="kt">Behavior</span> <span class="n">t</span> <span class="p">(</span><span class="kt">Event</span> <span class="n">t</span> <span class="n">a</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">Event</span> <span class="n">t</span> <span class="n">a</span>
</span></span><span class="line"><span class="cl">  <span class="n">now</span> <span class="ow">::</span> <span class="kt">Moment</span> <span class="n">t</span> <span class="p">(</span><span class="kt">Event</span> <span class="n">t</span> <span class="nb">()</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">sample</span> <span class="ow">::</span> <span class="kt">Behavior</span> <span class="n">t</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Moment</span> <span class="n">t</span> <span class="n">a</span>
</span></span><span class="line"><span class="cl">  <span class="n">hold</span> <span class="ow">::</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Event</span> <span class="n">t</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Moment</span> <span class="n">t</span> <span class="p">(</span><span class="kt">Behavior</span> <span class="n">t</span> <span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">mapMoment</span> <span class="ow">::</span> <span class="kt">Frp</span> <span class="n">t</span> <span class="ow">=&gt;</span> <span class="p">(</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Moment</span> <span class="n">t</span> <span class="n">b</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">Event</span> <span class="n">t</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Event</span> <span class="n">t</span> <span class="n">b</span>
</span></span><span class="line"><span class="cl"><span class="nf">mapMoment</span> <span class="n">f</span> <span class="ow">=</span> <span class="n">mapMaybeMoment</span> <span class="p">(</span><span class="n">fmap</span> <span class="kt">Just</span> <span class="o">.</span> <span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">instance</span> <span class="kt">Frp</span> <span class="n">t</span> <span class="ow">=&gt;</span> <span class="kt">Functor</span> <span class="p">(</span><span class="kt">Event</span> <span class="n">t</span><span class="p">)</span> <span class="kr">where</span>
</span></span><span class="line"><span class="cl">  <span class="n">fmap</span> <span class="n">f</span> <span class="ow">=</span> <span class="n">mapMaybeMoment</span> <span class="p">(</span><span class="n">pure</span> <span class="o">.</span> <span class="kt">Just</span> <span class="o">.</span> <span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">headE</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">Frp</span> <span class="n">t</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="kt">Event</span> <span class="n">t</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Moment</span> <span class="n">t</span> <span class="p">(</span><span class="kt">Event</span> <span class="n">t</span> <span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">headE</span> <span class="n">e</span> <span class="ow">=</span> <span class="n">mfix</span> <span class="o">$</span> <span class="n">fmap</span> <span class="n">switch</span> <span class="o">.</span> <span class="n">hold</span> <span class="n">e</span> <span class="o">.</span> <span class="n">fmap</span> <span class="p">(</span><span class="n">const</span> <span class="n">never</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">instance</span> <span class="p">(</span><span class="kt">Frp</span> <span class="n">t</span><span class="p">,</span> <span class="kt">Semigroup</span> <span class="n">a</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="kt">Semigroup</span> <span class="p">(</span><span class="kt">Event</span> <span class="n">t</span> <span class="n">a</span><span class="p">)</span> <span class="kr">where</span>
</span></span><span class="line"><span class="cl">  <span class="n">a</span> <span class="o">&lt;&gt;</span> <span class="n">b</span> <span class="ow">=</span> <span class="n">these</span> <span class="n">id</span> <span class="n">id</span> <span class="p">(</span><span class="o">&lt;&gt;</span><span class="p">)</span> <span class="o">&lt;$&gt;</span> <span class="n">merge</span> <span class="n">a</span> <span class="n">b</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">instance</span> <span class="p">(</span><span class="kt">Frp</span> <span class="n">t</span><span class="p">,</span> <span class="kt">Semigroup</span> <span class="n">a</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="kt">Monoid</span> <span class="p">(</span><span class="kt">Event</span> <span class="n">t</span> <span class="n">a</span><span class="p">)</span> <span class="kr">where</span>
</span></span><span class="line"><span class="cl">  <span class="n">mempty</span> <span class="ow">=</span> <span class="n">never</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="o">&lt;@&gt;</span><span class="p">)</span> <span class="ow">::</span> <span class="kt">Frp</span> <span class="n">t</span> <span class="ow">=&gt;</span> <span class="kt">Behavior</span> <span class="n">t</span> <span class="p">(</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">b</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">Event</span> <span class="n">t</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Event</span> <span class="n">t</span> <span class="n">b</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="o">&lt;@&gt;</span><span class="p">)</span> <span class="n">b</span> <span class="ow">=</span> <span class="n">mapMoment</span> <span class="o">$</span> <span class="nf">\</span><span class="n">x</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">  <span class="n">f</span> <span class="ow">&lt;-</span> <span class="n">sample</span> <span class="n">b</span>
</span></span><span class="line"><span class="cl">  <span class="n">pure</span> <span class="o">.</span> <span class="n">f</span> <span class="o">$</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl"><span class="kr">infixl</span> <span class="mi">4</span> <span class="o">&lt;@&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="o">&lt;@?&gt;</span><span class="p">)</span> <span class="ow">::</span> <span class="kt">Frp</span> <span class="n">t</span> <span class="ow">=&gt;</span> <span class="kt">Behavior</span> <span class="n">t</span> <span class="p">(</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Maybe</span> <span class="n">b</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">Event</span> <span class="n">t</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Event</span> <span class="n">t</span> <span class="n">b</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="o">&lt;@?&gt;</span><span class="p">)</span> <span class="n">b</span> <span class="ow">=</span> <span class="n">mapMaybeMoment</span> <span class="o">$</span> <span class="nf">\</span><span class="n">x</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">  <span class="n">f</span> <span class="ow">&lt;-</span> <span class="n">sample</span> <span class="n">b</span>
</span></span><span class="line"><span class="cl">  <span class="n">pure</span> <span class="o">.</span> <span class="n">f</span> <span class="o">$</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl"><span class="kr">infixl</span> <span class="mi">4</span> <span class="o">&lt;@?&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="o">&lt;@</span><span class="p">)</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">Frp</span> <span class="n">t</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="kt">Behavior</span> <span class="n">t</span> <span class="n">b</span> <span class="ow">-&gt;</span> <span class="kt">Event</span> <span class="n">t</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Event</span> <span class="n">t</span> <span class="n">b</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="o">&lt;@</span><span class="p">)</span> <span class="ow">=</span> <span class="n">tag</span>
</span></span><span class="line"><span class="cl"><span class="kr">infixl</span> <span class="mi">4</span> <span class="o">&lt;@</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">tag</span> <span class="ow">::</span> <span class="kt">Frp</span> <span class="n">t</span> <span class="ow">=&gt;</span> <span class="kt">Behavior</span> <span class="n">t</span> <span class="n">b</span> <span class="ow">-&gt;</span> <span class="kt">Event</span> <span class="n">t</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Event</span> <span class="n">t</span> <span class="n">b</span>
</span></span><span class="line"><span class="cl"><span class="nf">tag</span> <span class="n">b</span> <span class="ow">=</span> <span class="n">mapMoment</span> <span class="o">$</span> <span class="nf">\</span><span class="kr">_</span> <span class="ow">-&gt;</span> <span class="n">sample</span> <span class="n">b</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">accum</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">Frp</span> <span class="n">t</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="p">(</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">b</span> <span class="ow">-&gt;</span> <span class="n">a</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Event</span> <span class="n">t</span> <span class="n">b</span> <span class="ow">-&gt;</span> <span class="kt">Moment</span> <span class="n">t</span> <span class="p">(</span><span class="kt">Behavior</span> <span class="n">t</span> <span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">accum</span> <span class="n">f</span> <span class="n">a</span> <span class="n">e</span> <span class="ow">=</span> <span class="n">mfix</span> <span class="o">$</span> <span class="nf">\</span><span class="n">x</span> <span class="ow">-&gt;</span> <span class="n">hold</span> <span class="n">a</span> <span class="o">.</span> <span class="n">mapMoment</span> <span class="p">(</span><span class="nf">\</span><span class="n">b</span> <span class="ow">-&gt;</span> <span class="p">(`</span><span class="n">f</span><span class="p">`</span> <span class="n">b</span><span class="p">)</span> <span class="o">&lt;$&gt;</span> <span class="n">sample</span> <span class="n">x</span><span class="p">)</span> <span class="o">$</span> <span class="n">e</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">accumE</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">Frp</span> <span class="n">t</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="p">(</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">b</span> <span class="ow">-&gt;</span> <span class="n">a</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Event</span> <span class="n">t</span> <span class="n">b</span> <span class="ow">-&gt;</span> <span class="kt">Moment</span> <span class="n">t</span> <span class="p">(</span><span class="kt">Event</span> <span class="n">t</span> <span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">accumE</span> <span class="n">f</span> <span class="n">a</span> <span class="n">e</span> <span class="ow">=</span> <span class="n">mdo</span>
</span></span><span class="line"><span class="cl">  <span class="kr">let</span> <span class="n">e&#39;</span> <span class="ow">=</span> <span class="n">mapMoment</span> <span class="p">(</span><span class="nf">\</span><span class="n">q</span> <span class="ow">-&gt;</span> <span class="p">(`</span><span class="n">f</span><span class="p">`</span> <span class="n">q</span><span class="p">)</span> <span class="o">&lt;$&gt;</span> <span class="n">sample</span> <span class="n">b</span><span class="p">)</span> <span class="n">e</span>
</span></span><span class="line"><span class="cl">  <span class="n">b</span> <span class="ow">&lt;-</span> <span class="n">hold</span> <span class="n">a</span> <span class="n">e&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pure</span> <span class="n">e&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">count</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">Frp</span> <span class="n">t</span><span class="p">,</span> <span class="kt">Num</span> <span class="n">n</span><span class="p">,</span> <span class="kt">Enum</span> <span class="n">n</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="kt">Event</span> <span class="n">t</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Moment</span> <span class="n">t</span> <span class="p">(</span><span class="kt">Behavior</span> <span class="n">t</span> <span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">count</span> <span class="ow">=</span> <span class="n">accum</span> <span class="p">(</span><span class="nf">\</span><span class="n">a</span> <span class="kr">_</span> <span class="ow">-&gt;</span> <span class="n">succ</span> <span class="n">a</span><span class="p">)</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">attachWith</span> <span class="ow">::</span> <span class="kt">Frp</span> <span class="n">t</span> <span class="ow">=&gt;</span> <span class="p">(</span><span class="n">a1</span> <span class="ow">-&gt;</span> <span class="n">a2</span> <span class="ow">-&gt;</span> <span class="n">b</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">Behavior</span> <span class="n">t</span> <span class="n">a1</span> <span class="ow">-&gt;</span> <span class="kt">Event</span> <span class="n">t</span> <span class="n">a2</span> <span class="ow">-&gt;</span> <span class="kt">Event</span> <span class="n">t</span> <span class="n">b</span>
</span></span><span class="line"><span class="cl"><span class="nf">attachWith</span> <span class="n">f</span> <span class="n">b</span> <span class="n">e</span> <span class="ow">=</span> <span class="n">f</span> <span class="o">&lt;$&gt;</span> <span class="n">b</span> <span class="o">&lt;@&gt;</span> <span class="n">e</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">leftmost</span> <span class="ow">::</span> <span class="kt">Frp</span> <span class="n">t</span> <span class="ow">=&gt;</span> <span class="p">[</span><span class="kt">Event</span> <span class="n">t</span> <span class="n">a</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="kt">Event</span> <span class="n">t</span> <span class="n">a</span>
</span></span><span class="line"><span class="cl"><span class="nf">leftmost</span> <span class="ow">=</span> <span class="n">maybe</span> <span class="n">never</span> <span class="p">(</span><span class="n">fmap</span> <span class="n">getFirst</span> <span class="o">.</span> <span class="n">sconcat</span> <span class="o">.</span> <span class="n">fmap</span> <span class="p">(</span><span class="n">fmap</span> <span class="kt">First</span><span class="p">))</span> <span class="o">.</span> <span class="n">nonEmpty</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">mergeMap</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">Frp</span> <span class="n">t</span><span class="p">,</span> <span class="kt">Ord</span> <span class="n">k</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="kt">Map</span> <span class="n">k</span> <span class="p">(</span><span class="kt">Event</span> <span class="n">t</span> <span class="n">a</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">Event</span> <span class="n">t</span> <span class="p">(</span><span class="kt">Map</span> <span class="n">k</span> <span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">mergeMap</span> <span class="ow">=</span> <span class="n">mconcat</span> <span class="o">.</span> <span class="n">fmap</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">e</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">Map</span><span class="o">.</span><span class="n">singleton</span> <span class="n">t</span> <span class="o">&lt;$&gt;</span> <span class="n">e</span><span class="p">)</span> <span class="o">.</span> <span class="kt">Map</span><span class="o">.</span><span class="n">toList</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">switchHoldPromptly</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">Frp</span> <span class="n">t</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="kt">Event</span> <span class="n">t</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Event</span> <span class="n">t</span> <span class="p">(</span><span class="kt">Event</span> <span class="n">t</span> <span class="n">a</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">Moment</span> <span class="n">t</span> <span class="p">(</span><span class="kt">Event</span> <span class="n">t</span> <span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">switchHoldPromptly</span> <span class="n">ea0</span> <span class="n">eea</span> <span class="ow">=</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">  <span class="n">bea</span> <span class="ow">&lt;-</span> <span class="n">hold</span> <span class="n">ea0</span> <span class="n">eea</span>
</span></span><span class="line"><span class="cl">  <span class="kr">let</span> <span class="n">eLag</span> <span class="ow">=</span> <span class="n">switch</span> <span class="n">bea</span>
</span></span><span class="line"><span class="cl">      <span class="n">eCoincidences</span> <span class="ow">=</span> <span class="n">coincidence</span> <span class="n">eea</span>
</span></span><span class="line"><span class="cl">  <span class="n">return</span> <span class="o">$</span> <span class="n">leftmost</span> <span class="p">[</span><span class="n">eCoincidences</span><span class="p">,</span> <span class="n">eLag</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">instance</span> <span class="kt">Frp</span> <span class="n">t</span> <span class="ow">=&gt;</span> <span class="kt">Filterable</span> <span class="p">(</span><span class="kt">Event</span> <span class="n">t</span><span class="p">)</span> <span class="kr">where</span>
</span></span><span class="line"><span class="cl">  <span class="n">mapMaybe</span> <span class="n">f</span> <span class="ow">=</span> <span class="n">mapMaybeMoment</span> <span class="p">(</span><span class="n">pure</span> <span class="o">.</span> <span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">difference</span> <span class="ow">::</span> <span class="kt">Frp</span> <span class="n">t</span> <span class="ow">=&gt;</span> <span class="kt">Event</span> <span class="n">t</span> <span class="n">b1</span> <span class="ow">-&gt;</span> <span class="kt">Event</span> <span class="n">t</span> <span class="n">b2</span> <span class="ow">-&gt;</span> <span class="kt">Event</span> <span class="n">t</span> <span class="n">b1</span>
</span></span><span class="line"><span class="cl"><span class="nf">difference</span> <span class="n">a</span> <span class="n">b</span> <span class="ow">=</span> <span class="n">mapMaybe</span> <span class="n">justThis</span> <span class="o">$</span> <span class="n">merge</span> <span class="n">a</span> <span class="n">b</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">instance</span> <span class="kt">Frp</span> <span class="n">t</span> <span class="ow">=&gt;</span> <span class="kt">Semialign</span> <span class="p">(</span><span class="kt">Event</span> <span class="n">t</span><span class="p">)</span> <span class="kr">where</span>
</span></span><span class="line"><span class="cl">  <span class="n">align</span> <span class="ow">=</span> <span class="n">merge</span>
</span></span></code></pre></div><h3 id="semantics">Semantics</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="cm">{-# LANGUAGE TypeFamilies #-}</span>
</span></span><span class="line"><span class="cl"><span class="cm">{-|
</span></span></span><span class="line"><span class="cl"><span class="cm">Description: A pure (non-IO) implementation of the Frp interface.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">In this pure implementation of &#39;Frp.Class.Frp&#39;, events, Behaviors, and Moment are implemented as
</span></span></span><span class="line"><span class="cl"><span class="cm">functions of time.  The implementation avoids referencing time whenever possible to make it clear
</span></span></span><span class="line"><span class="cl"><span class="cm">which functions depend only on some &#34;current time&#34; or the past as well.
</span></span></span><span class="line"><span class="cl"><span class="cm">-}</span>
</span></span><span class="line"><span class="cl"><span class="kr">module</span> <span class="nn">Frp.Pure</span> <span class="kr">where</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Frp.Class</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.Kind</span> <span class="p">(</span><span class="kt">Type</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Control.Monad.Fix</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Control.Monad</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.Align</span> <span class="p">(</span><span class="nf">align</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Control.Monad.Trans.Maybe</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.Maybe</span> <span class="p">(</span> <span class="nf">fromMaybe</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">data</span> <span class="kt">Pure</span> <span class="p">(</span><span class="n">t</span> <span class="ow">::</span> <span class="kt">Type</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">instance</span> <span class="p">(</span><span class="kt">Ord</span> <span class="n">t</span><span class="p">,</span> <span class="kt">Enum</span> <span class="n">t</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="kt">Frp</span> <span class="p">(</span><span class="kt">Pure</span> <span class="n">t</span><span class="p">)</span> <span class="kr">where</span>
</span></span><span class="line"><span class="cl">  <span class="kr">newtype</span> <span class="kt">Behavior</span> <span class="p">(</span><span class="kt">Pure</span> <span class="n">t</span><span class="p">)</span> <span class="n">a</span> <span class="ow">=</span> <span class="kt">BehaviorP</span> <span class="p">{</span> <span class="n">at</span> <span class="ow">::</span> <span class="n">t</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kr">deriving</span> <span class="p">(</span><span class="kt">Functor</span><span class="p">,</span><span class="kt">Applicative</span><span class="p">,</span><span class="kt">Monad</span><span class="p">,</span><span class="kt">MonadFix</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">newtype</span> <span class="kt">Event</span> <span class="p">(</span><span class="kt">Pure</span> <span class="n">t</span><span class="p">)</span> <span class="n">a</span> <span class="ow">=</span> <span class="kt">EventP</span> <span class="p">{</span> <span class="n">occurs</span> <span class="ow">::</span> <span class="n">t</span> <span class="ow">-&gt;</span> <span class="kt">Maybe</span> <span class="n">a</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="kr">type</span> <span class="kt">Moment</span> <span class="p">(</span><span class="kt">Pure</span> <span class="n">t</span><span class="p">)</span> <span class="ow">=</span> <span class="p">(</span><span class="ow">-&gt;</span><span class="p">)</span> <span class="n">t</span>
</span></span><span class="line"><span class="cl">  <span class="n">mapMaybeMoment</span> <span class="n">f</span> <span class="ow">=</span> <span class="kt">EventP</span> <span class="o">.</span> <span class="n">runMaybeT</span> <span class="o">.</span> <span class="p">(</span><span class="kt">MaybeT</span> <span class="o">.</span> <span class="n">f</span> <span class="o">&lt;=&lt;</span> <span class="kt">MaybeT</span> <span class="o">.</span> <span class="n">occurs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">coincidence</span> <span class="ow">=</span> <span class="n">mapMaybeMoment</span> <span class="n">occurs</span>
</span></span><span class="line"><span class="cl">  <span class="n">merge</span> <span class="n">a</span> <span class="n">b</span> <span class="ow">=</span> <span class="kt">EventP</span> <span class="o">$</span> <span class="n">align</span> <span class="o">&lt;$&gt;</span> <span class="n">occurs</span> <span class="n">a</span> <span class="o">&lt;*&gt;</span> <span class="n">occurs</span> <span class="n">b</span>
</span></span><span class="line"><span class="cl">  <span class="n">never</span> <span class="ow">=</span> <span class="kt">EventP</span> <span class="o">$</span> <span class="n">pure</span> <span class="kt">Nothing</span>
</span></span><span class="line"><span class="cl">  <span class="n">switch</span> <span class="ow">=</span> <span class="kt">EventP</span> <span class="o">.</span> <span class="p">(</span><span class="n">occurs</span> <span class="o">&lt;=&lt;</span> <span class="n">sample</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">now</span> <span class="ow">=</span> <span class="n">fmap</span> <span class="p">(</span><span class="kt">EventP</span> <span class="o">.</span> <span class="n">fmap</span> <span class="n">guard</span><span class="p">)</span> <span class="p">(</span><span class="o">==</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">sample</span> <span class="ow">=</span> <span class="n">at</span>
</span></span><span class="line"><span class="cl">  <span class="n">hold</span> <span class="n">a</span> <span class="n">e</span> <span class="n">from</span> <span class="ow">=</span> <span class="kt">BehaviorP</span> <span class="o">$</span> <span class="nf">\</span><span class="n">t</span> <span class="ow">-&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">if</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="n">from</span>
</span></span><span class="line"><span class="cl">    <span class="kr">then</span> <span class="n">a</span>
</span></span><span class="line"><span class="cl">    <span class="kr">else</span> <span class="n">fromMaybe</span> <span class="p">(</span><span class="n">sample</span> <span class="p">(</span><span class="n">hold</span> <span class="n">a</span> <span class="n">e</span> <span class="n">from</span><span class="p">)</span> <span class="p">(</span><span class="n">pred</span> <span class="n">t</span><span class="p">))</span> <span class="o">$</span> <span class="n">occurs</span> <span class="n">e</span> <span class="p">(</span><span class="n">pred</span> <span class="n">t</span><span class="p">)</span>
</span></span></code></pre></div><h3 id="imperative-implementation">Imperative implementation</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="cm">{-# LANGUAGE ApplicativeDo #-}</span>
</span></span><span class="line"><span class="cl"><span class="cm">{-# LANGUAGE RecursiveDo #-}</span>
</span></span><span class="line"><span class="cl"><span class="cm">{-# LANGUAGE MultiParamTypeClasses #-}</span>
</span></span><span class="line"><span class="cl"><span class="cm">{-# LANGUAGE TypeFamilies #-}</span>
</span></span><span class="line"><span class="cl"><span class="cm">{-|
</span></span></span><span class="line"><span class="cl"><span class="cm">Description: An implementation of FRP via graph traversal.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">The implementation performs a number of actions for every &#34;frame&#34;.  A frame is a single logical
</span></span></span><span class="line"><span class="cl"><span class="cm">point in time at which any events might be occurring (including none occurring).  The full driving
</span></span></span><span class="line"><span class="cl"><span class="cm">algorithm can be seen in the &#39;runFrame&#39; function.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">First, a graph traversal algorithm visits every event to compute whether it occurs or not.  This
</span></span></span><span class="line"><span class="cl"><span class="cm">occurrence value is of a &#39;Maybe&#39; type, where &#39;Nothing&#39; signifies no occurrence.  The actual
</span></span></span><span class="line"><span class="cl"><span class="cm">traversal is embedded in the implementation of the combinators rather than having this concern
</span></span></span><span class="line"><span class="cl"><span class="cm">separated out.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">While traversing, IO actions are enqueued to take care of caching occurrences and unsubscribing
</span></span></span><span class="line"><span class="cl"><span class="cm">(with &#39;postTraversalQueueRef&#39;), as well as taking care of behavior initialization and updates (via
</span></span></span><span class="line"><span class="cl"><span class="cm">the &#39;behaviorInitsRef&#39; and &#39;behaviorAssignmentsRef&#39; queues).
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">After graph traversal, the various queues are processed and emptied.
</span></span></span><span class="line"><span class="cl"><span class="cm">-}</span>
</span></span><span class="line"><span class="cl"><span class="kr">module</span> <span class="nn">Frp.Impl</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="nf">newEvent</span><span class="p">,</span> <span class="nf">subscribeEvent</span><span class="p">,</span> <span class="nf">runFrame</span><span class="p">,</span> <span class="kt">Impl</span><span class="p">,</span> <span class="kt">EventTrigger</span><span class="p">,</span> <span class="kt">ReadTime</span><span class="p">,</span> <span class="nf">readBehavior</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">where</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Prelude</span> <span class="k">hiding</span> <span class="p">(</span><span class="nf">filter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Frp.Class</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Control.Monad.Fix</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Control.Monad</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.IORef</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.Align</span> <span class="p">(</span><span class="kt">Semialign</span><span class="p">(</span><span class="o">..</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.These</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.Maybe</span> <span class="p">(</span><span class="nf">fromMaybe</span><span class="p">,</span> <span class="nf">isJust</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">System.IO.Unsafe</span> <span class="p">(</span> <span class="nf">unsafePerformIO</span><span class="p">,</span> <span class="nf">unsafeInterleaveIO</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Data.IntMap</span> <span class="k">as</span> <span class="n">IntMap</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Control.Monad.Reader</span> <span class="p">(</span><span class="kt">ReaderT</span><span class="p">(</span><span class="o">..</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">GHC.IO</span> <span class="p">(</span><span class="nf">evaluate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Witherable</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.Foldable</span> <span class="p">(</span><span class="nf">for_</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">data</span> <span class="kt">Impl</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">type</span> <span class="kt">Propagator</span> <span class="n">a</span> <span class="ow">=</span> <span class="kt">Maybe</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="nb">()</span>
</span></span><span class="line"><span class="cl"><span class="kr">type</span> <span class="kt">Unsubscriber</span> <span class="ow">=</span> <span class="kt">IO</span> <span class="nb">()</span>
</span></span><span class="line"><span class="cl"><span class="kr">type</span> <span class="kt">Invalidator</span> <span class="ow">=</span> <span class="kt">IO</span> <span class="nb">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- | The root event &#39;rootTickE&#39; has an occurrence whenever any event might have one.</span>
</span></span><span class="line"><span class="cl"><span class="cm">{-# NOINLINE rootTickE #-}</span>
</span></span><span class="line"><span class="cl"><span class="nf">rootTickE</span> <span class="ow">::</span> <span class="kt">Event</span> <span class="kt">Impl</span> <span class="nb">()</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- | The &#39;propagateRoot&#39; action causes the root event to propagate with a unit-valued occurrence.</span>
</span></span><span class="line"><span class="cl"><span class="cm">{-# NOINLINE propagateRoot #-}</span>
</span></span><span class="line"><span class="cl"><span class="nf">propagateRoot</span> <span class="ow">::</span> <span class="kt">IO</span> <span class="nb">()</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">rootTickE</span><span class="p">,</span> <span class="n">propagateRoot</span><span class="p">)</span> <span class="ow">=</span> <span class="n">unsafePerformIO</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="n">eCached</span><span class="p">,</span> <span class="n">doPropagate</span><span class="p">)</span> <span class="ow">&lt;-</span> <span class="n">managedSubscribersEvent</span>
</span></span><span class="line"><span class="cl">  <span class="n">pure</span> <span class="p">(</span><span class="n">eCached</span><span class="p">,</span> <span class="n">doPropagate</span> <span class="p">(</span><span class="kt">Just</span> <span class="nb">()</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- |</span>
</span></span><span class="line"><span class="cl"><span class="kr">instance</span> <span class="kt">Frp</span> <span class="kt">Impl</span> <span class="kr">where</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- Events are subscribed to with a callback (&#39;Propagator&#39;), called whenever the event has a known</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- (non)-occurrence. Subscribing to an event returns an unsubscribe action. Unsubscribing stops</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- callbacks from happening. This unsubscribing might be immediate or only happen when</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- &#39;postTraversalQueueRef&#39; is processed.</span>
</span></span><span class="line"><span class="cl">  <span class="kr">newtype</span> <span class="kt">Event</span> <span class="kt">Impl</span> <span class="n">a</span> <span class="ow">=</span> <span class="kt">EventI</span> <span class="p">{</span> <span class="n">subscribe</span> <span class="ow">::</span> <span class="kt">Propagator</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="kt">Unsubscriber</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- Behaviors are sampling functions which are passed an optional invalidator. This invalidator</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- is run when the Behavior&#39;s value might change (but it could also stay the same).</span>
</span></span><span class="line"><span class="cl">  <span class="kr">newtype</span> <span class="kt">Behavior</span> <span class="kt">Impl</span> <span class="n">a</span> <span class="ow">=</span> <span class="kt">BehaviorI</span> <span class="p">(</span><span class="kt">ReaderT</span> <span class="p">(</span><span class="kt">Maybe</span> <span class="kt">Invalidator</span><span class="p">)</span> <span class="kt">IO</span> <span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">deriving</span> <span class="p">(</span><span class="kt">Functor</span><span class="p">,</span> <span class="kt">Applicative</span><span class="p">,</span> <span class="kt">Monad</span><span class="p">,</span> <span class="kt">MonadFix</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">type</span> <span class="kt">Moment</span> <span class="kt">Impl</span> <span class="ow">=</span> <span class="kt">IO</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">-- Never is implemented by filtering out all occurences from the root event.</span>
</span></span><span class="line"><span class="cl">  <span class="n">never</span> <span class="ow">::</span> <span class="kt">Event</span> <span class="kt">Impl</span> <span class="n">a</span>
</span></span><span class="line"><span class="cl">  <span class="n">never</span> <span class="ow">=</span> <span class="n">undefined</span> <span class="o">&lt;$</span> <span class="n">filter</span> <span class="p">(</span><span class="n">const</span> <span class="kt">False</span><span class="p">)</span> <span class="n">rootTickE</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">mapMaybeMoment</span> <span class="ow">::</span> <span class="p">(</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Moment</span> <span class="kt">Impl</span> <span class="p">(</span><span class="kt">Maybe</span> <span class="n">b</span><span class="p">))</span> <span class="ow">-&gt;</span> <span class="kt">Event</span> <span class="kt">Impl</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Event</span> <span class="kt">Impl</span> <span class="n">b</span>
</span></span><span class="line"><span class="cl">  <span class="n">mapMaybeMoment</span> <span class="n">f</span> <span class="n">e</span> <span class="ow">=</span> <span class="n">cacheEvent</span> <span class="o">$</span> <span class="kt">EventI</span> <span class="o">$</span> <span class="nf">\</span><span class="n">propagate</span> <span class="ow">-&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="n">subscribe</span> <span class="n">e</span> <span class="o">$</span> <span class="n">propagate</span> <span class="o">&lt;=&lt;</span> <span class="n">fmap</span> <span class="n">join</span> <span class="o">.</span> <span class="n">mapM</span> <span class="n">f</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">-- When the outer event is known to not have an occurrence, propagate non-occurrence. Otherwise,</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- subscribe to the inner occurrence and queue-up its unsubscribe action.  It&#39;s possible to write</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- the implementation so that unsubscribing happens immediately but using the queue made things</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- more succinct.</span>
</span></span><span class="line"><span class="cl">  <span class="n">coincidence</span> <span class="ow">::</span> <span class="kt">Event</span> <span class="kt">Impl</span> <span class="p">(</span><span class="kt">Event</span> <span class="kt">Impl</span> <span class="n">a</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">Event</span> <span class="kt">Impl</span> <span class="n">a</span>
</span></span><span class="line"><span class="cl">  <span class="n">coincidence</span> <span class="n">e</span> <span class="ow">=</span> <span class="n">cacheEvent</span> <span class="o">$</span> <span class="kt">EventI</span> <span class="o">$</span> <span class="nf">\</span><span class="n">propagate</span> <span class="ow">-&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="n">subscribe</span> <span class="n">e</span> <span class="o">$</span> <span class="n">maybe</span> <span class="p">(</span><span class="n">propagate</span> <span class="kt">Nothing</span><span class="p">)</span> <span class="p">(</span><span class="n">addToEnvQueue</span> <span class="n">postTraversalQueueRef</span> <span class="o">&lt;=&lt;</span> <span class="p">(`</span><span class="n">subscribe</span><span class="p">`</span> <span class="n">propagate</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">-- Subscribes to both merge inputs and cache the occurrences. When both (non-)occurrences are</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- known, propagate and clear the caches. Unsubscribing unsubscribes from both input events.</span>
</span></span><span class="line"><span class="cl">  <span class="n">merge</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">a</span> <span class="n">b</span><span class="o">.</span> <span class="kt">Event</span> <span class="kt">Impl</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Event</span> <span class="kt">Impl</span> <span class="n">b</span> <span class="ow">-&gt;</span> <span class="kt">Event</span> <span class="kt">Impl</span> <span class="p">(</span><span class="kt">These</span> <span class="n">a</span> <span class="n">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">merge</span> <span class="n">a</span> <span class="n">b</span> <span class="ow">=</span> <span class="n">cacheEvent</span> <span class="o">$</span> <span class="kt">EventI</span> <span class="o">$</span> <span class="nf">\</span><span class="n">propagate</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="n">aOccRef</span> <span class="ow">&lt;-</span> <span class="n">newIORef</span> <span class="kt">Nothing</span>
</span></span><span class="line"><span class="cl">    <span class="n">bOccRef</span> <span class="ow">&lt;-</span> <span class="n">newIORef</span> <span class="kt">Nothing</span>
</span></span><span class="line"><span class="cl">    <span class="kr">let</span> <span class="n">doSub</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">c</span><span class="o">.</span> <span class="kt">IORef</span> <span class="p">(</span><span class="kt">Maybe</span> <span class="p">(</span><span class="kt">Maybe</span> <span class="n">c</span><span class="p">))</span> <span class="ow">-&gt;</span> <span class="kt">Event</span> <span class="kt">Impl</span> <span class="n">c</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="kt">Unsubscriber</span>
</span></span><span class="line"><span class="cl">        <span class="n">doSub</span> <span class="n">occRef</span> <span class="n">e</span> <span class="ow">=</span> <span class="n">subscribe</span> <span class="n">e</span> <span class="o">$</span> <span class="nf">\</span><span class="n">occ</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">            <span class="n">writeIORef</span> <span class="n">occRef</span> <span class="o">.</span> <span class="kt">Just</span> <span class="o">$</span> <span class="n">occ</span>
</span></span><span class="line"><span class="cl">            <span class="c1">-- Check if we have both inputs when any input is called. If yes, clear caches and</span>
</span></span><span class="line"><span class="cl">            <span class="c1">-- propagate.</span>
</span></span><span class="line"><span class="cl">            <span class="n">mapM_</span> <span class="p">(</span><span class="nf">\</span><span class="n">occRes</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">                      <span class="n">writeIORef</span> <span class="n">aOccRef</span> <span class="kt">Nothing</span>
</span></span><span class="line"><span class="cl">                      <span class="n">writeIORef</span> <span class="n">bOccRef</span> <span class="kt">Nothing</span>
</span></span><span class="line"><span class="cl">                      <span class="n">propagate</span> <span class="n">occRes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="o">=&lt;&lt;</span> <span class="n">liftA2</span> <span class="n">align</span> <span class="o">&lt;$&gt;</span> <span class="n">readIORef</span> <span class="n">aOccRef</span> <span class="o">&lt;*&gt;</span> <span class="n">readIORef</span> <span class="n">bOccRef</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="o">&gt;&gt;</span><span class="p">)</span> <span class="o">&lt;$&gt;</span> <span class="n">doSub</span> <span class="n">aOccRef</span> <span class="n">a</span> <span class="o">&lt;*&gt;</span> <span class="n">doSub</span> <span class="n">bOccRef</span> <span class="n">b</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">-- Switch keeps the unsubscriber to the inner event in an &#39;IORef (Maybe Unsubscriber)&#39;. As long as</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- the result event of switch is subscribed to, the IORef is kept as Just Unsubscriber. On</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- unsubscribing it&#39;s set to Nothing. When switchParent&#39;s invalidator runs, the old inner event is</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- unsubscribed from and the IORef set to the new one. The invalidator only runs if the IORef is</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- Just-valued still, so that unsubscribing from the resulting switch event stops new</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- subscriptions (and semantics-breaking propagations) from happening.</span>
</span></span><span class="line"><span class="cl">  <span class="n">switch</span> <span class="ow">::</span> <span class="kt">Behavior</span> <span class="kt">Impl</span> <span class="p">(</span><span class="kt">Event</span> <span class="kt">Impl</span> <span class="n">a</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">Event</span> <span class="kt">Impl</span> <span class="n">a</span>
</span></span><span class="line"><span class="cl">  <span class="n">switch</span> <span class="p">(</span><span class="kt">BehaviorI</span> <span class="n">switchParent</span><span class="p">)</span> <span class="ow">=</span> <span class="n">cacheEvent</span> <span class="o">$</span> <span class="kt">EventI</span> <span class="o">$</span> <span class="nf">\</span><span class="n">propagate</span> <span class="ow">-&gt;</span> <span class="n">mdo</span>
</span></span><span class="line"><span class="cl">    <span class="kr">let</span> <span class="n">unsubscribeAndSetUnsubscriberWith</span> <span class="ow">::</span> <span class="kt">IO</span> <span class="p">(</span><span class="kt">Maybe</span> <span class="p">(</span><span class="kt">IO</span> <span class="nb">()</span><span class="p">))</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="nb">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">unsubscribeAndSetUnsubscriberWith</span> <span class="n">f</span> <span class="ow">=</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">          <span class="n">maybeUnsubscribeInner</span> <span class="ow">&lt;-</span> <span class="n">readIORef</span> <span class="n">maybeUnsubscribeInnerERef</span>
</span></span><span class="line"><span class="cl">          <span class="n">for_</span> <span class="n">maybeUnsubscribeInner</span> <span class="o">$</span> <span class="nf">\</span><span class="n">unsubscribe</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">            <span class="n">unsubscribe</span>
</span></span><span class="line"><span class="cl">            <span class="n">writeIORef</span> <span class="n">maybeUnsubscribeInnerERef</span> <span class="o">=&lt;&lt;</span> <span class="n">f</span>
</span></span><span class="line"><span class="cl">    <span class="n">maybeUnsubscribeInnerERef</span> <span class="ow">::</span> <span class="kt">IORef</span> <span class="p">(</span><span class="kt">Maybe</span> <span class="kt">Unsubscriber</span><span class="p">)</span> <span class="ow">&lt;-</span>
</span></span><span class="line"><span class="cl">      <span class="n">newIORef</span> <span class="o">&lt;=&lt;</span> <span class="n">fix</span> <span class="o">$</span> <span class="nf">\</span><span class="n">subscribeAndResetOnInvalidate</span> <span class="ow">-&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="n">fmap</span> <span class="kt">Just</span> <span class="o">.</span> <span class="p">(`</span><span class="n">subscribe</span><span class="p">`</span> <span class="n">propagate</span><span class="p">)</span> <span class="o">&lt;=&lt;</span> <span class="n">runReaderT</span> <span class="n">switchParent</span> <span class="o">.</span> <span class="kt">Just</span>
</span></span><span class="line"><span class="cl">        <span class="o">$</span> <span class="n">unsubscribeAndSetUnsubscriberWith</span> <span class="n">subscribeAndResetOnInvalidate</span>
</span></span><span class="line"><span class="cl">    <span class="n">pure</span> <span class="o">$</span> <span class="n">unsubscribeAndSetUnsubscriberWith</span> <span class="p">(</span><span class="n">pure</span> <span class="kt">Nothing</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">-- Hold returns a behavior which is initialized at behavior init time and changes at behavior</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- assignment time. Whenever the behavior is sampled an invalidator action can be added which is</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- called when the behavior changes. This is used to implement &#39;switch&#39;.</span>
</span></span><span class="line"><span class="cl">  <span class="n">hold</span> <span class="ow">::</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Event</span> <span class="kt">Impl</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Moment</span> <span class="kt">Impl</span> <span class="p">(</span><span class="kt">Behavior</span> <span class="kt">Impl</span> <span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">hold</span> <span class="n">v0</span> <span class="n">e</span> <span class="ow">=</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="n">invsRef</span> <span class="ow">&lt;-</span> <span class="n">newIORef</span> <span class="kt">[]</span> <span class="c1">-- The list of invalidators that have to run whenever the result behavior</span>
</span></span><span class="line"><span class="cl">                           <span class="c1">-- changes.</span>
</span></span><span class="line"><span class="cl">    <span class="n">valRef</span> <span class="ow">&lt;-</span> <span class="n">newIORef</span> <span class="n">v0</span>
</span></span><span class="line"><span class="cl">    <span class="c1">-- Make sure not to touch &#39;e&#39; eagerly, instead wait for Behavior init time.</span>
</span></span><span class="line"><span class="cl">    <span class="n">addToEnvQueue</span> <span class="n">behaviorInitsRef</span> <span class="o">$</span> <span class="n">void</span> <span class="o">$</span> <span class="n">subscribe</span> <span class="n">e</span> <span class="o">$</span>
</span></span><span class="line"><span class="cl">      <span class="n">mapM_</span> <span class="p">(</span><span class="nf">\</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">addToEnvQueue</span> <span class="n">behaviorAssignmentsRef</span> <span class="o">$</span> <span class="kt">BehaviorAssignment</span> <span class="n">valRef</span> <span class="n">a</span> <span class="n">invsRef</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">pure</span> <span class="o">$</span> <span class="kt">BehaviorI</span> <span class="o">$</span> <span class="kt">ReaderT</span> <span class="o">$</span> <span class="nf">\</span><span class="n">invalidator</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">mapM_</span> <span class="p">(</span><span class="n">modifyIORef</span> <span class="n">invsRef</span> <span class="o">.</span> <span class="p">(</span><span class="kt">:</span><span class="p">))</span> <span class="n">invalidator</span>
</span></span><span class="line"><span class="cl">      <span class="n">readIORef</span> <span class="n">valRef</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">now</span> <span class="ow">::</span> <span class="kt">Moment</span> <span class="kt">Impl</span> <span class="p">(</span><span class="kt">Event</span> <span class="kt">Impl</span> <span class="nb">()</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">now</span> <span class="ow">=</span> <span class="n">headE</span> <span class="n">rootTickE</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">-- Sample takes extra care to be lazy by delaying the evaluation of the sampled behavior.  The</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- last moment by which the sample would need to be forced is the behavior&#39;s invalidation time,</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- but here I&#39;ve forced the evaluation at the next behavior init time.</span>
</span></span><span class="line"><span class="cl">  <span class="n">sample</span> <span class="ow">::</span> <span class="kt">Behavior</span> <span class="kt">Impl</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Moment</span> <span class="kt">Impl</span> <span class="n">a</span>
</span></span><span class="line"><span class="cl">  <span class="n">sample</span> <span class="p">(</span><span class="kt">BehaviorI</span> <span class="n">b</span><span class="p">)</span> <span class="ow">=</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="n">res</span> <span class="ow">&lt;-</span> <span class="n">unsafeInterleaveIO</span> <span class="o">$</span> <span class="n">runReaderT</span> <span class="n">b</span> <span class="kt">Nothing</span>
</span></span><span class="line"><span class="cl">    <span class="n">addToEnvQueue</span> <span class="n">behaviorInitsRef</span> <span class="o">$</span> <span class="n">void</span> <span class="o">.</span> <span class="n">evaluate</span> <span class="o">$</span> <span class="n">res</span>
</span></span><span class="line"><span class="cl">    <span class="n">pure</span> <span class="n">res</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- | An update to a behavior&#39;s cached value.</span>
</span></span><span class="line"><span class="cl"><span class="kr">data</span> <span class="kt">BehaviorAssignment</span> <span class="kr">where</span>
</span></span><span class="line"><span class="cl">  <span class="kt">BehaviorAssignment</span> <span class="ow">::</span> <span class="kt">IORef</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">IORef</span> <span class="p">[</span><span class="kt">Invalidator</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="kt">BehaviorAssignment</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- | Returns a cached event which can have multiple subscribers and a propagating/cache update</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- procedure. The propagator is not allowed to be called outside of a frame (this is unenforced)!</span>
</span></span><span class="line"><span class="cl"><span class="nf">managedSubscribersEvent</span> <span class="ow">::</span> <span class="kt">IO</span> <span class="p">(</span><span class="kt">Event</span> <span class="kt">Impl</span> <span class="n">a</span><span class="p">,</span> <span class="kt">Maybe</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="nb">()</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">managedSubscribersEvent</span> <span class="ow">=</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">  <span class="n">subscribersRef</span> <span class="ow">&lt;-</span> <span class="n">newIORef</span> <span class="n">mempty</span>
</span></span><span class="line"><span class="cl">  <span class="n">ctrRef</span> <span class="ow">&lt;-</span> <span class="n">newIORef</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="n">occRef</span> <span class="ow">&lt;-</span> <span class="n">newIORef</span> <span class="kt">Nothing</span>
</span></span><span class="line"><span class="cl">  <span class="n">pure</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span> <span class="kt">EventI</span> <span class="o">$</span> <span class="nf">\</span><span class="n">propagate</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">        <span class="n">thisSubId</span> <span class="ow">&lt;-</span> <span class="n">atomicModifyIORef</span> <span class="n">ctrRef</span> <span class="p">(</span><span class="nf">\</span><span class="n">i</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">succ</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">modifyIORef</span> <span class="n">subscribersRef</span> <span class="o">$</span> <span class="kt">IntMap</span><span class="o">.</span><span class="n">insert</span> <span class="n">thisSubId</span> <span class="n">propagate</span>
</span></span><span class="line"><span class="cl">        <span class="c1">-- If occRef is already Just we have to propagate on subscribe</span>
</span></span><span class="line"><span class="cl">        <span class="c1">-- because the subscription on e has already propagated:</span>
</span></span><span class="line"><span class="cl">        <span class="n">mapM_</span> <span class="n">propagate</span> <span class="o">=&lt;&lt;</span> <span class="n">readIORef</span> <span class="n">occRef</span>
</span></span><span class="line"><span class="cl">        <span class="n">pure</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">          <span class="n">old</span> <span class="ow">&lt;-</span> <span class="n">readIORef</span> <span class="n">subscribersRef</span>
</span></span><span class="line"><span class="cl">          <span class="n">unless</span> <span class="p">(</span><span class="kt">IntMap</span><span class="o">.</span><span class="n">member</span> <span class="n">thisSubId</span> <span class="n">old</span><span class="p">)</span> <span class="o">$</span> <span class="ne">error</span> <span class="s">&#34;managedSubscribers unsubscribed twice&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="n">modifyIORef</span> <span class="n">subscribersRef</span> <span class="p">(</span><span class="kt">IntMap</span><span class="o">.</span><span class="n">delete</span> <span class="n">thisSubId</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">,</span> <span class="nf">\</span><span class="n">occ</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">        <span class="n">writeAndScheduleClear</span> <span class="n">occRef</span> <span class="n">occ</span>
</span></span><span class="line"><span class="cl">        <span class="n">mapM_</span> <span class="p">(</span><span class="o">$</span> <span class="n">occ</span><span class="p">)</span> <span class="o">=&lt;&lt;</span> <span class="n">readIORef</span> <span class="n">subscribersRef</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- | Cache event occurrences.</span>
</span></span><span class="line"><span class="cl"><span class="nf">cacheEvent</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">a</span><span class="o">.</span> <span class="kt">Event</span> <span class="kt">Impl</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Event</span> <span class="kt">Impl</span> <span class="n">a</span>
</span></span><span class="line"><span class="cl"><span class="nf">cacheEvent</span> <span class="n">e</span> <span class="ow">=</span> <span class="n">unsafePerformIO</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="n">eCached</span><span class="p">,</span> <span class="n">doPropagate</span><span class="p">)</span> <span class="ow">&lt;-</span> <span class="n">managedSubscribersEvent</span>
</span></span><span class="line"><span class="cl">  <span class="n">void</span> <span class="o">.</span> <span class="n">subscribe</span> <span class="n">e</span> <span class="o">$</span> <span class="n">doPropagate</span>
</span></span><span class="line"><span class="cl">  <span class="n">pure</span> <span class="n">eCached</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- | For use in &#39;runFrame&#39;.</span>
</span></span><span class="line"><span class="cl"><span class="kr">newtype</span> <span class="kt">EventTrigger</span> <span class="ow">=</span> <span class="kt">EventTrigger</span> <span class="p">{</span> <span class="n">runEventTrigger</span> <span class="ow">::</span> <span class="kt">IO</span> <span class="nb">()</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- | Create a new event. Returns a &#34;make trigger&#34; function to which you can pass an occurrence value</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- and obtain an &#39;EventTrigger&#39; for use with &#39;runFrame&#39;, and the new event.</span>
</span></span><span class="line"><span class="cl"><span class="nf">newEvent</span> <span class="ow">::</span> <span class="kt">IO</span> <span class="p">(</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">EventTrigger</span><span class="p">,</span> <span class="kt">Event</span> <span class="kt">Impl</span> <span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">newEvent</span> <span class="ow">=</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">  <span class="n">occRef</span> <span class="ow">&lt;-</span> <span class="n">newIORef</span> <span class="kt">Nothing</span> <span class="c1">-- Root event (non-)occurrence is always &#34;known&#34;, thus Maybe a</span>
</span></span><span class="line"><span class="cl">  <span class="n">pure</span> <span class="p">(</span> <span class="kt">EventTrigger</span> <span class="o">.</span> <span class="n">writeAndScheduleClear</span> <span class="n">occRef</span>
</span></span><span class="line"><span class="cl">       <span class="p">,</span> <span class="n">mapMaybeMoment</span> <span class="p">(</span><span class="n">const</span> <span class="p">(</span><span class="n">readIORef</span> <span class="n">occRef</span><span class="p">))</span> <span class="n">rootTickE</span>
</span></span><span class="line"><span class="cl">       <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- | Subscribe to an event to obtain a &#34;read occurrence&#34; action which will contain the event</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- occurrence value when read inside the &#39;program&#39; argument of &#39;runFrame&#39;.</span>
</span></span><span class="line"><span class="cl"><span class="nf">subscribeEvent</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">a</span><span class="o">.</span> <span class="kt">Event</span> <span class="kt">Impl</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="p">(</span><span class="kt">ReadTime</span> <span class="p">(</span><span class="kt">Maybe</span> <span class="n">a</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="nf">subscribeEvent</span> <span class="n">e</span> <span class="ow">=</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">  <span class="n">occRef</span> <span class="ow">::</span> <span class="kt">IORef</span> <span class="p">(</span><span class="kt">Maybe</span> <span class="p">(</span><span class="kt">Maybe</span> <span class="n">a</span><span class="p">))</span> <span class="ow">&lt;-</span> <span class="n">newIORef</span> <span class="kt">Nothing</span>
</span></span><span class="line"><span class="cl">  <span class="kr">_</span> <span class="ow">&lt;-</span> <span class="n">subscribe</span> <span class="n">e</span> <span class="o">$</span> <span class="n">writeAndScheduleClear</span> <span class="n">occRef</span>
</span></span><span class="line"><span class="cl">  <span class="n">pure</span> <span class="o">$</span> <span class="kt">ReadTime</span> <span class="o">$</span> <span class="n">fromMaybe</span> <span class="p">(</span><span class="ne">error</span> <span class="s">&#34;Occurrence read outside of runFrame?&#34;</span><span class="p">)</span> <span class="o">&lt;$&gt;</span> <span class="n">readIORef</span> <span class="n">occRef</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- | For use in obtaining Event and Behavior values in &#39;runFrame&#39;.</span>
</span></span><span class="line"><span class="cl"><span class="kr">newtype</span> <span class="kt">ReadTime</span> <span class="n">a</span> <span class="ow">=</span> <span class="kt">ReadTime</span> <span class="p">{</span> <span class="n">runReadTime</span> <span class="ow">::</span> <span class="kt">IO</span> <span class="n">a</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="kr">deriving</span> <span class="p">(</span><span class="kt">Functor</span><span class="p">,</span><span class="kt">Applicative</span><span class="p">,</span><span class="kt">Monad</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- | Return the current value of the behavior at &#34;read time&#34;. If you want to read the next value of</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- a behavior you&#39;ll have to run &#39;runFrame&#39; again, which can be done without triggering any events.</span>
</span></span><span class="line"><span class="cl"><span class="nf">readBehavior</span> <span class="ow">::</span> <span class="kt">Behavior</span> <span class="kt">Impl</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">ReadTime</span> <span class="n">a</span>
</span></span><span class="line"><span class="cl"><span class="nf">readBehavior</span> <span class="p">(</span><span class="kt">BehaviorI</span> <span class="n">b</span><span class="p">)</span> <span class="ow">=</span> <span class="kt">ReadTime</span> <span class="o">$</span> <span class="n">runReaderT</span> <span class="n">b</span> <span class="kt">Nothing</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- | Inside the second argument you can read behaviors with &#39;readBehavior&#39; and event occurrences</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- (after subscribing to an event with &#39;subscribeEvent&#39;).</span>
</span></span><span class="line"><span class="cl"><span class="nf">runFrame</span> <span class="ow">::</span> <span class="p">[</span><span class="kt">EventTrigger</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="kt">ReadTime</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="n">a</span>
</span></span><span class="line"><span class="cl"><span class="nf">runFrame</span> <span class="n">triggers</span> <span class="n">program</span> <span class="ow">=</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">  <span class="kr">let</span> <span class="p">(</span><span class="kt">Env</span> <span class="p">{</span> <span class="n">postTraversalQueueRef</span><span class="p">,</span> <span class="n">behaviorInitsRef</span><span class="p">,</span> <span class="n">behaviorAssignmentsRef</span> <span class="p">})</span> <span class="ow">=</span> <span class="n">theEnv</span>
</span></span><span class="line"><span class="cl">  <span class="n">mapM_</span> <span class="n">runEventTrigger</span> <span class="n">triggers</span>
</span></span><span class="line"><span class="cl">  <span class="n">propagateRoot</span>
</span></span><span class="line"><span class="cl">  <span class="n">res</span> <span class="ow">&lt;-</span> <span class="n">runReadTime</span> <span class="n">program</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- Lazily initialize behaviors here. Behavior initialization can queue up other behavior</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- initialization if an untouched behavior is sampled.</span>
</span></span><span class="line"><span class="cl">  <span class="n">fix</span> <span class="o">$</span> <span class="nf">\</span><span class="n">runHoldInits</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="n">inits</span> <span class="ow">&lt;-</span> <span class="n">readIORef</span> <span class="n">behaviorInitsRef</span>
</span></span><span class="line"><span class="cl">    <span class="n">unless</span> <span class="p">(</span><span class="n">null</span> <span class="n">inits</span><span class="p">)</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">writeIORef</span> <span class="n">behaviorInitsRef</span> <span class="kt">[]</span>
</span></span><span class="line"><span class="cl">      <span class="n">sequence_</span> <span class="n">inits</span>
</span></span><span class="line"><span class="cl">      <span class="n">runHoldInits</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- Clear event occurrence caches and unsubscribe from events.</span>
</span></span><span class="line"><span class="cl">  <span class="n">atomicModifyIORef</span> <span class="n">postTraversalQueueRef</span> <span class="p">(</span><span class="kt">[]</span><span class="p">,)</span> <span class="o">&gt;&gt;=</span> <span class="n">sequence_</span>
</span></span><span class="line"><span class="cl">  <span class="c1">-- Perform the updates of the behaviors&#39; cached values.</span>
</span></span><span class="line"><span class="cl">  <span class="n">atomicModifyIORef</span> <span class="n">behaviorAssignmentsRef</span> <span class="p">(</span><span class="kt">[]</span><span class="p">,)</span>
</span></span><span class="line"><span class="cl">    <span class="o">&gt;&gt;=</span> <span class="n">mapM_</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="kt">BehaviorAssignment</span> <span class="n">valRef</span> <span class="n">a</span> <span class="n">invalidatorsRef</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">                  <span class="n">writeIORef</span> <span class="n">valRef</span> <span class="n">a</span>
</span></span><span class="line"><span class="cl">                  <span class="n">atomicModifyIORef</span> <span class="n">invalidatorsRef</span> <span class="p">(</span><span class="kt">[]</span><span class="p">,)</span> <span class="o">&gt;&gt;=</span> <span class="n">sequence_</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">flip</span> <span class="n">unless</span> <span class="p">(</span><span class="ne">error</span> <span class="s">&#34;queues were not empty after runFrame&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span> <span class="n">and</span> <span class="o">=&lt;&lt;</span> <span class="n">sequence</span> <span class="p">[</span> <span class="n">null</span> <span class="o">&lt;$&gt;</span> <span class="n">readIORef</span> <span class="n">behaviorInitsRef</span>
</span></span><span class="line"><span class="cl">                       <span class="p">,</span> <span class="n">null</span> <span class="o">&lt;$&gt;</span> <span class="n">readIORef</span> <span class="n">postTraversalQueueRef</span>
</span></span><span class="line"><span class="cl">                       <span class="p">,</span> <span class="n">null</span> <span class="o">&lt;$&gt;</span> <span class="n">readIORef</span> <span class="n">behaviorAssignmentsRef</span>
</span></span><span class="line"><span class="cl">                       <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="n">pure</span> <span class="n">res</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- | Write a value to an event occurrence cache/IORef and schedule it to be cleared.</span>
</span></span><span class="line"><span class="cl"><span class="nf">writeAndScheduleClear</span> <span class="ow">::</span> <span class="kt">IORef</span> <span class="p">(</span><span class="kt">Maybe</span> <span class="n">a</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="nb">()</span>
</span></span><span class="line"><span class="cl"><span class="nf">writeAndScheduleClear</span> <span class="n">occRef</span> <span class="n">a</span> <span class="ow">=</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">  <span class="n">prev</span> <span class="ow">&lt;-</span> <span class="n">readIORef</span> <span class="n">occRef</span>
</span></span><span class="line"><span class="cl">  <span class="n">when</span> <span class="p">(</span><span class="n">isJust</span> <span class="n">prev</span><span class="p">)</span> <span class="o">$</span> <span class="ne">error</span> <span class="s">&#34;occRef written twice---loop?&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">writeIORef</span> <span class="n">occRef</span> <span class="p">(</span><span class="kt">Just</span> <span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">addToEnvQueue</span> <span class="n">postTraversalQueueRef</span> <span class="o">$</span> <span class="n">writeIORef</span> <span class="n">occRef</span> <span class="kt">Nothing</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- | See &#39;runFrame&#39; for how these queues are processed and used.</span>
</span></span><span class="line"><span class="cl"><span class="kr">data</span> <span class="kt">Env</span> <span class="ow">=</span> <span class="kt">Env</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span> <span class="n">postTraversalQueueRef</span> <span class="ow">::</span> <span class="kt">IORef</span> <span class="p">[</span><span class="kt">IO</span> <span class="nb">()</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">behaviorInitsRef</span> <span class="ow">::</span> <span class="kt">IORef</span> <span class="p">[</span><span class="kt">IO</span> <span class="nb">()</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">behaviorAssignmentsRef</span> <span class="ow">::</span> <span class="kt">IORef</span> <span class="p">[</span><span class="kt">BehaviorAssignment</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">{-# NOINLINE theEnv #-}</span>
</span></span><span class="line"><span class="cl"><span class="nf">theEnv</span> <span class="ow">::</span> <span class="kt">Env</span>
</span></span><span class="line"><span class="cl"><span class="nf">theEnv</span> <span class="ow">=</span> <span class="n">unsafePerformIO</span> <span class="o">$</span> <span class="kt">Env</span> <span class="o">&lt;$&gt;</span> <span class="n">newIORef</span> <span class="kt">[]</span> <span class="o">&lt;*&gt;</span> <span class="n">newIORef</span> <span class="kt">[]</span> <span class="o">&lt;*&gt;</span> <span class="n">newIORef</span> <span class="kt">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">addToEnvQueue</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">Env</span> <span class="ow">-&gt;</span> <span class="kt">IORef</span> <span class="p">[</span><span class="n">a</span><span class="p">])</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="nb">()</span>
</span></span><span class="line"><span class="cl"><span class="nf">addToEnvQueue</span> <span class="n">selector</span> <span class="n">a</span> <span class="ow">=</span> <span class="n">modifyIORef</span> <span class="p">(</span><span class="n">selector</span> <span class="n">theEnv</span><span class="p">)</span> <span class="p">(</span><span class="n">a</span><span class="kt">:</span><span class="p">)</span>
</span></span></code></pre></div><h3 id="tests">Tests</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-haskell" data-lang="haskell"><span class="line"><span class="cl"><span class="cm">{-# LANGUAGE LambdaCase #-}</span>
</span></span><span class="line"><span class="cl"><span class="cm">{-# LANGUAGE TypeFamilies #-}</span>
</span></span><span class="line"><span class="cl"><span class="cm">{-# LANGUAGE RecursiveDo #-}</span>
</span></span><span class="line"><span class="cl"><span class="cm">{-# LANGUAGE RankNTypes #-}</span>
</span></span><span class="line"><span class="cl"><span class="cm">{-# LANGUAGE PartialTypeSignatures #-}</span>
</span></span><span class="line"><span class="cl"><span class="cm">{-# LANGUAGE FunctionalDependencies #-}</span>
</span></span><span class="line"><span class="cl"><span class="kr">module</span> <span class="nn">Frp.Test</span> <span class="kr">where</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Frp.Impl</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Frp.Class</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.Kind</span> <span class="p">(</span><span class="kt">Type</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Control.Monad.State</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.IntMap</span> <span class="p">(</span><span class="kt">IntMap</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Data.IntMap</span> <span class="k">as</span> <span class="n">IntMap</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">System.Mem</span> <span class="p">(</span><span class="nf">performGC</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Witherable</span> <span class="p">(</span><span class="nf">catMaybes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Frp.Pure</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.Bifunctor</span> <span class="p">(</span><span class="nf">first</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Data.IntSet</span> <span class="k">as</span> <span class="n">IntSet</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Control.Monad.Fix</span> <span class="p">(</span><span class="kt">MonadFix</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.Maybe</span> <span class="p">(</span><span class="nf">fromMaybe</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Control.Monad</span> <span class="p">(</span><span class="nf">forM</span><span class="p">,</span> <span class="nf">when</span><span class="p">,</span> <span class="nf">join</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Data.Map</span> <span class="k">as</span> <span class="n">Map</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">System.Exit</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.Char</span> <span class="p">(</span><span class="nf">toUpper</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.Functor</span> <span class="p">(</span><span class="nf">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nn">Data.IntSet</span> <span class="p">(</span><span class="kt">IntSet</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">newtype</span> <span class="kt">PlanImpl</span> <span class="n">a</span> <span class="kr">where</span>
</span></span><span class="line"><span class="cl">  <span class="kt">PlanImpl</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">StateT</span> <span class="kt">Schedule</span> <span class="p">(</span><span class="kt">Moment</span> <span class="kt">Impl</span><span class="p">)</span> <span class="n">a</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">PlanImpl</span> <span class="n">a</span>
</span></span><span class="line"><span class="cl">  <span class="kr">deriving</span> <span class="p">(</span><span class="kt">Functor</span><span class="p">,</span><span class="kt">Applicative</span><span class="p">,</span><span class="kt">Monad</span><span class="p">,</span><span class="kt">MonadFix</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">type</span> <span class="kt">Schedule</span> <span class="ow">=</span> <span class="kt">IntMap</span> <span class="p">[</span><span class="kt">EventTrigger</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">newtype</span> <span class="kt">PlanPure</span> <span class="n">a</span> <span class="ow">=</span> <span class="kt">PlanPure</span> <span class="p">(</span><span class="kt">StateT</span> <span class="kt">IntSet</span> <span class="p">(</span><span class="kt">Moment</span> <span class="p">(</span><span class="kt">Pure</span> <span class="kt">Int</span><span class="p">))</span> <span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">deriving</span> <span class="p">(</span><span class="kt">Functor</span><span class="p">,</span><span class="kt">Applicative</span><span class="p">,</span><span class="kt">Monad</span><span class="p">,</span><span class="kt">MonadFix</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">instance</span> <span class="nb">()</span> <span class="ow">=&gt;</span> <span class="kt">TestPlan</span> <span class="kt">Impl</span> <span class="kt">PlanImpl</span> <span class="kr">where</span>
</span></span><span class="line"><span class="cl">  <span class="n">plan</span> <span class="n">occurrences</span> <span class="ow">=</span> <span class="kt">PlanImpl</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="n">makeTrigger</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="ow">&lt;-</span> <span class="n">liftIO</span> <span class="n">newEvent</span>
</span></span><span class="line"><span class="cl">    <span class="n">modify</span> <span class="o">.</span> <span class="kt">IntMap</span><span class="o">.</span><span class="n">unionWith</span> <span class="n">mappend</span> <span class="o">.</span> <span class="kt">IntMap</span><span class="o">.</span><span class="n">fromList</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span> <span class="n">fmap</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">fromIntegral</span> <span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">makeTrigger</span> <span class="n">a</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">      <span class="o">$</span> <span class="n">occurrences</span>
</span></span><span class="line"><span class="cl">    <span class="n">pure</span> <span class="n">e</span>
</span></span><span class="line"><span class="cl">  <span class="n">liftPlan</span> <span class="ow">=</span> <span class="kt">PlanImpl</span> <span class="o">.</span> <span class="n">lift</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">mapToPureEvent</span> <span class="ow">::</span> <span class="kt">IntMap</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Event</span> <span class="p">(</span><span class="kt">Pure</span> <span class="kt">Int</span><span class="p">)</span> <span class="n">a</span>
</span></span><span class="line"><span class="cl"><span class="nf">mapToPureEvent</span> <span class="n">m</span> <span class="ow">=</span> <span class="kt">EventP</span> <span class="o">$</span> <span class="n">flip</span> <span class="kt">IntMap</span><span class="o">.</span><span class="n">lookup</span> <span class="n">m</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">instance</span> <span class="kt">TestPlan</span> <span class="p">(</span><span class="kt">Pure</span> <span class="kt">Int</span><span class="p">)</span> <span class="kt">PlanPure</span> <span class="kr">where</span>
</span></span><span class="line"><span class="cl">  <span class="n">plan</span> <span class="n">occurrences</span> <span class="ow">=</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="kr">let</span> <span class="n">m</span> <span class="ow">=</span> <span class="kt">IntMap</span><span class="o">.</span><span class="n">fromList</span> <span class="p">(</span><span class="n">first</span> <span class="n">fromIntegral</span> <span class="o">&lt;$&gt;</span> <span class="n">occurrences</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kt">PlanPure</span> <span class="o">.</span> <span class="n">modify</span> <span class="o">$</span> <span class="kt">IntSet</span><span class="o">.</span><span class="n">union</span> <span class="p">(</span><span class="kt">IntMap</span><span class="o">.</span><span class="n">keysSet</span> <span class="n">m</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">pure</span> <span class="o">$</span> <span class="n">mapToPureEvent</span> <span class="n">m</span>
</span></span><span class="line"><span class="cl">  <span class="n">liftPlan</span> <span class="ow">=</span> <span class="kt">PlanPure</span> <span class="o">.</span> <span class="n">lift</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">runPlanImplE</span> <span class="ow">::</span> <span class="kt">PlanImpl</span> <span class="p">(</span><span class="kt">Event</span> <span class="kt">Impl</span> <span class="n">b</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="p">(</span><span class="kt">IntMap</span> <span class="n">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">runPlanImplE</span> <span class="p">(</span><span class="kt">PlanImpl</span> <span class="n">x</span><span class="p">)</span> <span class="ow">=</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="n">s</span><span class="p">)</span> <span class="ow">&lt;-</span> <span class="n">runStateT</span> <span class="n">x</span> <span class="n">mempty</span>
</span></span><span class="line"><span class="cl">  <span class="n">readOcc</span> <span class="ow">&lt;-</span> <span class="n">subscribeEvent</span> <span class="n">e</span>
</span></span><span class="line"><span class="cl">  <span class="n">catMaybes</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;$&gt;</span> <span class="n">traverse</span> <span class="p">(</span><span class="nf">\</span><span class="n">occs</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">                             <span class="n">performGC</span>
</span></span><span class="line"><span class="cl">                             <span class="n">runFrame</span> <span class="n">occs</span> <span class="n">readOcc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">makeDense</span> <span class="n">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">-- TODO: commonalities between runPlanImpl*</span>
</span></span><span class="line"><span class="cl"><span class="nf">runPlanImplB</span> <span class="ow">::</span> <span class="kt">PlanImpl</span> <span class="p">(</span><span class="kt">Behavior</span> <span class="kt">Impl</span> <span class="n">b</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="p">(</span><span class="kt">IntMap</span> <span class="n">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">runPlanImplB</span> <span class="p">(</span><span class="kt">PlanImpl</span> <span class="n">x</span><span class="p">)</span> <span class="ow">=</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">s</span><span class="p">)</span> <span class="ow">&lt;-</span> <span class="n">runStateT</span> <span class="n">x</span> <span class="n">mempty</span>
</span></span><span class="line"><span class="cl">  <span class="n">traverse</span> <span class="p">(</span><span class="nf">\</span><span class="n">occs</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">               <span class="n">performGC</span>
</span></span><span class="line"><span class="cl">               <span class="n">runFrame</span> <span class="n">occs</span> <span class="p">(</span><span class="n">readBehavior</span> <span class="n">b</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="n">makeDense</span> <span class="n">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">runPure</span> <span class="ow">::</span> <span class="kt">PlanPure</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="kt">IntSet</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">runPure</span> <span class="p">(</span><span class="kt">PlanPure</span> <span class="n">p</span><span class="p">)</span> <span class="ow">=</span> <span class="n">runStateT</span> <span class="n">p</span> <span class="n">mempty</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">relevantTimes</span> <span class="ow">::</span> <span class="kt">IntSet</span> <span class="ow">-&gt;</span> <span class="kt">IntSet</span>
</span></span><span class="line"><span class="cl"><span class="nf">relevantTimes</span> <span class="n">occs</span> <span class="ow">=</span> <span class="kt">IntSet</span><span class="o">.</span><span class="n">fromList</span> <span class="p">[</span><span class="mi">0</span><span class="o">..</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="kr">where</span> <span class="n">l</span> <span class="ow">=</span> <span class="n">maybe</span> <span class="mi">0</span> <span class="n">fst</span> <span class="p">(</span><span class="kt">IntSet</span><span class="o">.</span><span class="n">maxView</span> <span class="n">occs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">testBehavior</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">Behavior</span> <span class="p">(</span><span class="kt">Pure</span> <span class="kt">Int</span><span class="p">)</span> <span class="n">a</span><span class="p">,</span> <span class="kt">IntSet</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">IntMap</span> <span class="n">a</span>
</span></span><span class="line"><span class="cl"><span class="nf">testBehavior</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">occs</span><span class="p">)</span> <span class="ow">=</span> <span class="kt">IntMap</span><span class="o">.</span><span class="n">fromSet</span> <span class="p">(</span><span class="n">sample</span> <span class="n">b</span><span class="p">)</span> <span class="p">(</span><span class="n">relevantTimes</span> <span class="n">occs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">testEvent</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">Event</span> <span class="p">(</span><span class="kt">Pure</span> <span class="kt">Int</span><span class="p">)</span> <span class="n">a</span><span class="p">,</span> <span class="kt">IntSet</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">IntMap</span> <span class="n">a</span>
</span></span><span class="line"><span class="cl"><span class="nf">testEvent</span> <span class="p">(</span><span class="kt">EventP</span> <span class="n">readEvent</span><span class="p">,</span> <span class="n">occs</span><span class="p">)</span> <span class="ow">=</span> <span class="n">catMaybes</span> <span class="o">$</span> <span class="kt">IntMap</span><span class="o">.</span><span class="n">fromSet</span> <span class="n">readEvent</span> <span class="p">(</span><span class="n">relevantTimes</span> <span class="n">occs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">makeDense</span> <span class="ow">::</span> <span class="kt">IntMap</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="kt">IntMap</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">makeDense</span> <span class="n">s</span> <span class="ow">=</span> <span class="n">fromMaybe</span> <span class="p">(</span><span class="n">emptyRange</span> <span class="mi">0</span><span class="p">)</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="kr">_</span><span class="p">)</span> <span class="ow">&lt;-</span> <span class="n">fst</span> <span class="o">&lt;$&gt;</span> <span class="kt">IntMap</span><span class="o">.</span><span class="n">maxViewWithKey</span> <span class="n">s</span>
</span></span><span class="line"><span class="cl">  <span class="n">return</span> <span class="o">$</span> <span class="kt">IntMap</span><span class="o">.</span><span class="n">union</span> <span class="n">s</span> <span class="p">(</span><span class="n">emptyRange</span> <span class="n">end</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">where</span>
</span></span><span class="line"><span class="cl">      <span class="n">emptyRange</span> <span class="n">end</span> <span class="ow">=</span> <span class="kt">IntMap</span><span class="o">.</span><span class="n">fromList</span> <span class="p">(</span><span class="n">map</span> <span class="p">(,</span> <span class="kt">[]</span><span class="p">)</span> <span class="p">[</span><span class="mi">0</span><span class="o">..</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">class</span> <span class="p">(</span><span class="kt">Frp</span> <span class="n">t</span><span class="p">,</span> <span class="kt">Monad</span> <span class="n">m</span><span class="p">,</span> <span class="kt">MonadFix</span> <span class="n">m</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="kt">TestPlan</span> <span class="p">(</span><span class="n">t</span> <span class="ow">::</span> <span class="kt">Type</span><span class="p">)</span> <span class="n">m</span> <span class="o">|</span> <span class="n">m</span> <span class="ow">-&gt;</span> <span class="n">t</span> <span class="kr">where</span>
</span></span><span class="line"><span class="cl">  <span class="n">plan</span> <span class="ow">::</span> <span class="p">[(</span><span class="kt">Word</span><span class="p">,</span> <span class="n">a</span><span class="p">)]</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="p">(</span><span class="kt">Event</span> <span class="n">t</span> <span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">liftPlan</span> <span class="ow">::</span> <span class="kt">Moment</span> <span class="n">t</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">a</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">planList</span> <span class="ow">::</span> <span class="kt">TestPlan</span> <span class="n">t</span> <span class="n">m</span> <span class="ow">=&gt;</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="p">(</span><span class="kt">Event</span> <span class="n">t</span> <span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">planList</span> <span class="n">xs</span> <span class="ow">=</span> <span class="n">plan</span> <span class="o">$</span> <span class="n">zip</span> <span class="p">[</span><span class="mi">1</span><span class="o">..</span><span class="p">]</span> <span class="n">xs</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">type</span> <span class="kt">TestE</span> <span class="n">a</span> <span class="ow">=</span> <span class="n">forall</span> <span class="n">t</span> <span class="n">m</span><span class="o">.</span> <span class="kt">TestPlan</span> <span class="n">t</span> <span class="n">m</span> <span class="ow">=&gt;</span> <span class="n">m</span> <span class="p">(</span><span class="kt">Event</span> <span class="n">t</span> <span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">type</span> <span class="kt">TestB</span> <span class="n">a</span> <span class="ow">=</span> <span class="n">forall</span> <span class="n">t</span> <span class="n">m</span><span class="o">.</span> <span class="kt">TestPlan</span> <span class="n">t</span> <span class="n">m</span> <span class="ow">=&gt;</span> <span class="n">m</span> <span class="p">(</span><span class="kt">Behavior</span> <span class="n">t</span> <span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">data</span> <span class="kt">TestCase</span>  <span class="kr">where</span>
</span></span><span class="line"><span class="cl">  <span class="kt">TestE</span>  <span class="ow">::</span> <span class="p">(</span><span class="kt">Show</span> <span class="n">a</span><span class="p">,</span> <span class="kt">Eq</span> <span class="n">a</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="kt">TestE</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">TestCase</span>
</span></span><span class="line"><span class="cl">  <span class="kt">TestB</span>  <span class="ow">::</span> <span class="p">(</span><span class="kt">Show</span> <span class="n">a</span><span class="p">,</span> <span class="kt">Eq</span> <span class="n">a</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="kt">TestB</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">TestCase</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">-- Helpers to declare test cases</span>
</span></span><span class="line"><span class="cl"><span class="nf">testE</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">Eq</span> <span class="n">a</span><span class="p">,</span> <span class="kt">Show</span> <span class="n">a</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">TestE</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="kt">String</span><span class="p">,</span> <span class="kt">TestCase</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">testE</span> <span class="n">name</span> <span class="n">test</span> <span class="ow">=</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kt">TestE</span> <span class="n">test</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">testB</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">Eq</span> <span class="n">a</span><span class="p">,</span> <span class="kt">Show</span> <span class="n">a</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">TestB</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="kt">String</span><span class="p">,</span> <span class="kt">TestCase</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">testB</span> <span class="n">name</span> <span class="n">test</span> <span class="ow">=</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kt">TestB</span> <span class="n">test</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">testAgreement</span> <span class="ow">::</span> <span class="kt">TestCase</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="kt">Bool</span>
</span></span><span class="line"><span class="cl"><span class="nf">testAgreement</span> <span class="ow">=</span> <span class="nf">\</span><span class="kr">case</span>
</span></span><span class="line"><span class="cl">  <span class="kt">TestE</span> <span class="n">p</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="n">impl</span> <span class="ow">&lt;-</span> <span class="n">runPlanImplE</span> <span class="n">p</span>
</span></span><span class="line"><span class="cl">    <span class="kr">let</span> <span class="n">results</span> <span class="ow">=</span> <span class="p">[(</span><span class="s">&#34;impl&#34;</span><span class="p">,</span> <span class="n">impl</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="n">compareResult</span> <span class="n">results</span> <span class="p">(</span><span class="n">testEvent</span> <span class="o">$</span> <span class="n">runPure</span> <span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kt">TestB</span> <span class="n">p</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="n">impl</span> <span class="ow">&lt;-</span> <span class="n">runPlanImplB</span> <span class="n">p</span>
</span></span><span class="line"><span class="cl">    <span class="kr">let</span> <span class="n">results</span> <span class="ow">=</span> <span class="p">[(</span><span class="s">&#34;impl&#34;</span><span class="p">,</span> <span class="n">impl</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="n">compareResult</span> <span class="n">results</span> <span class="p">(</span><span class="n">testBehavior</span> <span class="o">$</span> <span class="n">runPure</span> <span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">compareResult</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">Show</span> <span class="n">a</span><span class="p">,</span> <span class="kt">Eq</span> <span class="n">a</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="p">[(</span><span class="kt">String</span><span class="p">,</span> <span class="kt">IntMap</span> <span class="n">a</span><span class="p">)]</span> <span class="ow">-&gt;</span> <span class="kt">IntMap</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="kt">Bool</span>
</span></span><span class="line"><span class="cl"><span class="nf">compareResult</span> <span class="n">results</span> <span class="n">expected</span> <span class="ow">=</span> <span class="n">fmap</span> <span class="n">and</span> <span class="o">$</span> <span class="n">forM</span> <span class="n">results</span> <span class="o">$</span> <span class="nf">\</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">  <span class="n">when</span> <span class="p">(</span><span class="n">r</span> <span class="o">/=</span> <span class="n">expected</span><span class="p">)</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="n">putStrLn</span> <span class="p">(</span><span class="s">&#34;Got: &#34;</span> <span class="o">++</span> <span class="n">show</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">putStrLn</span> <span class="p">(</span><span class="s">&#34;Expected: &#34;</span> <span class="o">++</span> <span class="n">show</span> <span class="n">expected</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">pure</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="n">expected</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">runTests</span> <span class="ow">::</span> <span class="p">[(</span><span class="kt">String</span><span class="p">,</span> <span class="kt">TestCase</span><span class="p">)]</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="nb">()</span>
</span></span><span class="line"><span class="cl"><span class="nf">runTests</span> <span class="n">cases</span> <span class="ow">=</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">   <span class="n">results</span> <span class="ow">&lt;-</span> <span class="n">forM</span> <span class="n">cases</span> <span class="o">$</span> <span class="nf">\</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">test</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">     <span class="n">putStrLn</span> <span class="o">$</span> <span class="s">&#34;Test: &#34;</span> <span class="o">&lt;&gt;</span> <span class="n">name</span>
</span></span><span class="line"><span class="cl">     <span class="n">testAgreement</span> <span class="n">test</span>
</span></span><span class="line"><span class="cl">   <span class="n">exitWith</span> <span class="o">$</span> <span class="kr">if</span> <span class="n">and</span> <span class="n">results</span>
</span></span><span class="line"><span class="cl">              <span class="kr">then</span> <span class="kt">ExitSuccess</span>
</span></span><span class="line"><span class="cl">              <span class="kr">else</span> <span class="kt">ExitFailure</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">testCases</span> <span class="ow">::</span> <span class="p">[(</span><span class="kt">String</span><span class="p">,</span> <span class="kt">TestCase</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="nf">testCases</span> <span class="ow">=</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span> <span class="n">testB</span> <span class="s">&#34;hold-0&#34;</span>  <span class="o">$</span> <span class="n">liftPlan</span> <span class="o">.</span> <span class="n">hold</span> <span class="s">&#34;0&#34;</span> <span class="o">=&lt;&lt;</span> <span class="n">events1</span>
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testB</span> <span class="s">&#34;count&#34;</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">b</span> <span class="ow">&lt;-</span> <span class="n">liftPlan</span> <span class="o">.</span> <span class="n">count</span> <span class="o">=&lt;&lt;</span> <span class="n">events2</span>
</span></span><span class="line"><span class="cl">      <span class="n">pure</span> <span class="o">$</span> <span class="p">(</span><span class="o">+</span> <span class="p">(</span><span class="mi">0</span><span class="ow">::</span><span class="kt">Int</span><span class="p">))</span> <span class="o">&lt;$&gt;</span> <span class="n">b</span>
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testB</span> <span class="s">&#34;behavior-0&#34;</span> <span class="o">$</span> <span class="n">liftA2</span> <span class="p">(</span><span class="o">&lt;&gt;</span><span class="p">)</span> <span class="o">&lt;$&gt;</span> <span class="n">behavior1</span> <span class="o">&lt;*&gt;</span> <span class="n">behavior2</span>
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testB</span> <span class="s">&#34;behavior-1&#34;</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">es</span> <span class="ow">&lt;-</span> <span class="n">planList</span> <span class="p">[</span><span class="s">&#34;a&#34;</span><span class="p">,</span> <span class="s">&#34;b&#34;</span><span class="p">,</span> <span class="s">&#34;c&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">      <span class="n">e</span> <span class="ow">&lt;-</span> <span class="n">plan</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">()</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">      <span class="n">b</span> <span class="ow">&lt;-</span> <span class="n">liftPlan</span> <span class="o">$</span> <span class="n">hold</span> <span class="p">(</span><span class="n">pure</span> <span class="s">&#34;&#34;</span><span class="p">)</span> <span class="o">$</span>
</span></span><span class="line"><span class="cl">        <span class="n">mapMoment</span> <span class="p">(</span><span class="n">const</span> <span class="o">$</span> <span class="n">hold</span> <span class="s">&#34;z&#34;</span> <span class="n">es</span><span class="p">)</span> <span class="n">e</span>
</span></span><span class="line"><span class="cl">      <span class="n">pure</span> <span class="p">(</span><span class="n">join</span> <span class="n">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;id&#34;</span> <span class="n">events2</span>
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;fmap-simple&#34;</span> <span class="o">$</span> <span class="n">fmap</span> <span class="p">(</span><span class="o">&lt;&gt;</span> <span class="s">&#34;x&#34;</span><span class="p">)</span> <span class="o">&lt;$&gt;</span> <span class="n">events2</span>
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;tag-1&#34;</span> <span class="o">$</span> <span class="p">(</span><span class="o">&lt;@</span><span class="p">)</span> <span class="o">&lt;$&gt;</span> <span class="n">behavior1</span> <span class="o">&lt;*&gt;</span> <span class="n">events2</span>
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;tag-2&#34;</span> <span class="o">$</span> <span class="p">(</span><span class="o">&lt;@</span><span class="p">)</span> <span class="o">&lt;$&gt;</span> <span class="p">(</span><span class="n">fmap</span> <span class="p">(</span><span class="n">fmap</span> <span class="n">toUpper</span><span class="p">)</span> <span class="o">&lt;$&gt;</span> <span class="n">behavior1</span><span class="p">)</span> <span class="o">&lt;*&gt;</span> <span class="n">events2</span>
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;attach-1&#34;</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">b1</span> <span class="ow">&lt;-</span> <span class="n">behavior1</span>
</span></span><span class="line"><span class="cl">      <span class="n">attachWith</span> <span class="p">(</span><span class="o">++</span><span class="p">)</span> <span class="p">(</span><span class="n">fmap</span> <span class="n">toUpper</span> <span class="o">&lt;$&gt;</span> <span class="n">b1</span><span class="p">)</span> <span class="o">&lt;$&gt;</span> <span class="n">events2</span>
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;leftmost&#34;</span> <span class="o">$</span> <span class="n">liftA2</span> <span class="n">leftmost2</span> <span class="n">events1</span> <span class="n">events2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;appendEvents-1&#34;</span> <span class="o">$</span> <span class="n">liftA2</span> <span class="n">mappend</span> <span class="n">events1</span> <span class="n">events2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;appendEvents-2&#34;</span> <span class="o">$</span> <span class="n">liftA2</span> <span class="n">mappend</span> <span class="n">events3</span> <span class="n">events2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;merge-1&#34;</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">e</span> <span class="ow">&lt;-</span> <span class="n">events1</span>
</span></span><span class="line"><span class="cl">      <span class="n">pure</span> <span class="o">$</span> <span class="n">leftmost</span> <span class="p">[</span><span class="s">&#34;x&#34;</span> <span class="o">&lt;$</span> <span class="n">e</span><span class="p">,</span> <span class="s">&#34;y&#34;</span> <span class="o">&lt;$</span> <span class="n">e</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;merge-2&#34;</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">e</span> <span class="ow">&lt;-</span> <span class="n">events1</span>
</span></span><span class="line"><span class="cl">      <span class="kr">let</span> <span class="n">m</span> <span class="ow">=</span> <span class="n">mergeMap</span> <span class="o">$</span> <span class="kt">Map</span><span class="o">.</span><span class="n">fromList</span> <span class="p">[(</span><span class="mi">1</span><span class="ow">::</span><span class="kt">Int</span><span class="p">,</span> <span class="s">&#34;y&#34;</span> <span class="o">&lt;$</span> <span class="n">e</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&#34;z&#34;</span> <span class="o">&lt;$</span> <span class="n">e</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">      <span class="kr">let</span> <span class="n">ee</span> <span class="ow">=</span> <span class="n">flip</span> <span class="n">mapMoment</span> <span class="n">e</span> <span class="o">$</span> <span class="n">const</span> <span class="o">$</span> <span class="n">pure</span> <span class="n">m</span>
</span></span><span class="line"><span class="cl">      <span class="n">pure</span> <span class="o">$</span> <span class="n">coincidence</span> <span class="n">ee</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;headE-0&#34;</span> <span class="o">$</span> <span class="n">liftPlan</span> <span class="o">.</span> <span class="n">headE</span> <span class="o">=&lt;&lt;</span> <span class="n">events1</span>
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;headE-1&#34;</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">e</span> <span class="ow">&lt;-</span> <span class="n">events1</span>
</span></span><span class="line"><span class="cl">      <span class="n">liftPlan</span> <span class="o">$</span> <span class="n">headE</span> <span class="o">$</span> <span class="n">leftmost</span> <span class="p">[</span><span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;headE-2&#34;</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">e</span> <span class="ow">&lt;-</span> <span class="n">events1</span>
</span></span><span class="line"><span class="cl">      <span class="n">liftPlan</span> <span class="o">$</span> <span class="kr">do</span> <span class="n">b</span> <span class="ow">&lt;-</span> <span class="n">hold</span> <span class="n">never</span> <span class="p">(</span><span class="n">e</span> <span class="o">&lt;$</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">headE</span> <span class="o">$</span> <span class="n">switch</span> <span class="n">b</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;switch-1&#34;</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">e</span> <span class="ow">&lt;-</span> <span class="n">events1</span>
</span></span><span class="line"><span class="cl">      <span class="n">b</span> <span class="ow">&lt;-</span> <span class="n">liftPlan</span> <span class="o">$</span> <span class="n">hold</span> <span class="n">never</span> <span class="p">(</span><span class="n">e</span> <span class="o">&lt;$</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">pure</span> <span class="o">$</span> <span class="n">switch</span> <span class="n">b</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;switch-2&#34;</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">e</span> <span class="ow">&lt;-</span> <span class="n">events1</span>
</span></span><span class="line"><span class="cl">      <span class="n">pure</span> <span class="o">$</span> <span class="n">coincidence</span> <span class="o">$</span> <span class="n">flip</span> <span class="n">mapMoment</span> <span class="n">e</span> <span class="o">$</span> <span class="n">const</span> <span class="o">$</span> <span class="n">switch</span> <span class="o">&lt;$&gt;</span> <span class="n">hold</span> <span class="p">(</span><span class="n">leftmost</span> <span class="p">[</span><span class="s">&#34;x&#34;</span> <span class="o">&lt;$</span> <span class="n">e</span><span class="p">,</span> <span class="s">&#34;y&#34;</span> <span class="o">&lt;$</span> <span class="n">e</span><span class="p">,</span> <span class="s">&#34;z&#34;</span> <span class="o">&lt;$</span> <span class="n">e</span><span class="p">])</span> <span class="p">(</span><span class="n">e</span> <span class="o">&lt;$</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;switch-3&#34;</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">e</span> <span class="ow">&lt;-</span> <span class="n">events1</span>
</span></span><span class="line"><span class="cl">      <span class="n">pure</span> <span class="o">$</span> <span class="n">coincidence</span> <span class="o">$</span> <span class="n">flip</span> <span class="n">mapMoment</span> <span class="n">e</span> <span class="o">$</span> <span class="n">const</span> <span class="o">$</span> <span class="n">switch</span> <span class="o">&lt;$&gt;</span> <span class="n">hold</span> <span class="p">(</span><span class="n">leftmost</span> <span class="p">[</span><span class="s">&#34;x&#34;</span> <span class="o">&lt;$</span> <span class="n">e</span><span class="p">,</span> <span class="s">&#34;y&#34;</span> <span class="o">&lt;$</span> <span class="n">e</span><span class="p">,</span> <span class="s">&#34;z&#34;</span> <span class="o">&lt;$</span> <span class="n">e</span><span class="p">])</span> <span class="n">never</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;switch-4&#34;</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">e</span> <span class="ow">&lt;-</span> <span class="n">events1</span>
</span></span><span class="line"><span class="cl">      <span class="n">liftPlan</span> <span class="o">$</span> <span class="n">switch</span> <span class="o">&lt;$&gt;</span> <span class="n">hold</span> <span class="p">(</span><span class="n">deep</span> <span class="n">e</span><span class="p">)</span> <span class="p">(</span><span class="n">e</span> <span class="o">&lt;$</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;switch-5&#34;</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">e</span> <span class="ow">&lt;-</span> <span class="n">events1</span>
</span></span><span class="line"><span class="cl">      <span class="n">pure</span> <span class="o">$</span> <span class="n">coincidence</span> <span class="o">$</span> <span class="n">flip</span> <span class="n">mapMoment</span> <span class="n">e</span> <span class="o">$</span> <span class="n">const</span> <span class="o">$</span>
</span></span><span class="line"><span class="cl">        <span class="n">pure</span> <span class="o">$</span> <span class="n">leftmost</span> <span class="p">[</span><span class="s">&#34;x&#34;</span> <span class="o">&lt;$</span> <span class="n">e</span><span class="p">,</span> <span class="s">&#34;y&#34;</span> <span class="o">&lt;$</span> <span class="n">e</span><span class="p">,</span> <span class="s">&#34;z&#34;</span> <span class="o">&lt;$</span> <span class="n">e</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;switch-6&#34;</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">e</span> <span class="ow">&lt;-</span> <span class="n">events1</span>
</span></span><span class="line"><span class="cl">      <span class="n">pure</span> <span class="o">$</span> <span class="n">coincidence</span> <span class="o">$</span> <span class="n">flip</span> <span class="n">mapMoment</span> <span class="n">e</span> <span class="o">$</span> <span class="n">const</span> <span class="o">$</span> <span class="n">switch</span> <span class="o">&lt;$&gt;</span> <span class="n">hold</span> <span class="p">(</span><span class="s">&#34;x&#34;</span> <span class="o">&lt;$</span> <span class="n">e</span><span class="p">)</span> <span class="p">(</span><span class="n">e</span> <span class="o">&lt;$</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;switchHoldPromptly-1&#34;</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">e</span> <span class="ow">&lt;-</span> <span class="n">events1</span>
</span></span><span class="line"><span class="cl">      <span class="kr">let</span> <span class="n">e&#39;</span> <span class="ow">=</span> <span class="n">e</span> <span class="o">&lt;$</span> <span class="n">e</span>
</span></span><span class="line"><span class="cl">      <span class="n">liftPlan</span> <span class="o">$</span> <span class="n">switchHoldPromptly</span> <span class="n">never</span> <span class="o">$</span> <span class="n">e</span> <span class="o">&lt;$</span> <span class="n">e&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;switchHoldPromptly-2&#34;</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">e</span> <span class="ow">&lt;-</span> <span class="n">events1</span>
</span></span><span class="line"><span class="cl">      <span class="n">liftPlan</span> <span class="o">$</span> <span class="n">switchHoldPromptly</span> <span class="n">never</span> <span class="o">$</span> <span class="n">deep</span> <span class="p">(</span><span class="n">e</span> <span class="o">&lt;$</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;switchHoldPromptly-3&#34;</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">e</span> <span class="ow">&lt;-</span> <span class="n">events1</span>
</span></span><span class="line"><span class="cl">      <span class="n">liftPlan</span> <span class="o">$</span> <span class="n">switchHoldPromptly</span> <span class="n">never</span> <span class="p">(</span><span class="n">e</span> <span class="o">&lt;$</span> <span class="n">deep</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;switchHoldPromptly-4&#34;</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">e</span> <span class="ow">&lt;-</span> <span class="n">events1</span>
</span></span><span class="line"><span class="cl">      <span class="n">liftPlan</span> <span class="o">$</span> <span class="n">switchHoldPromptly</span> <span class="n">never</span> <span class="p">(</span><span class="n">deep</span> <span class="n">e</span> <span class="o">&lt;$</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;switch-6&#34;</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">e</span> <span class="ow">&lt;-</span> <span class="n">events1</span>
</span></span><span class="line"><span class="cl">      <span class="n">liftPlan</span> <span class="o">$</span> <span class="n">switch</span> <span class="o">&lt;$&gt;</span> <span class="n">hold</span> <span class="n">never</span> <span class="p">(</span><span class="n">deep</span> <span class="n">e</span> <span class="o">&lt;$</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;switchHoldPromptly-5&#34;</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="n">e</span> <span class="ow">&lt;-</span> <span class="n">events1</span>
</span></span><span class="line"><span class="cl">    <span class="n">liftPlan</span> <span class="o">$</span> <span class="n">switchHoldPromptly</span> <span class="n">never</span> <span class="o">$</span> <span class="n">flip</span> <span class="n">mapMaybeMoment</span> <span class="n">e</span> <span class="o">$</span>
</span></span><span class="line"><span class="cl">      <span class="n">const</span> <span class="p">(</span><span class="kt">Just</span> <span class="o">&lt;$&gt;</span> <span class="n">headE</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;switchHoldPromptly-6&#34;</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">e</span> <span class="ow">&lt;-</span> <span class="n">events1</span>
</span></span><span class="line"><span class="cl">      <span class="n">liftPlan</span> <span class="o">$</span> <span class="n">switchHoldPromptly</span> <span class="n">never</span> <span class="o">$</span> <span class="n">flip</span> <span class="n">mapMoment</span> <span class="n">e</span> <span class="o">$</span>
</span></span><span class="line"><span class="cl">        <span class="n">const</span> <span class="p">(</span><span class="n">switchHoldPromptly</span> <span class="n">e</span> <span class="n">never</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;coincidence-1&#34;</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">e</span> <span class="ow">&lt;-</span> <span class="n">events1</span>
</span></span><span class="line"><span class="cl">      <span class="n">pure</span> <span class="o">$</span> <span class="n">coincidence</span> <span class="o">$</span> <span class="n">flip</span> <span class="n">mapMoment</span> <span class="n">e</span> <span class="o">$</span>
</span></span><span class="line"><span class="cl">        <span class="n">const</span> <span class="o">$</span> <span class="n">pure</span> <span class="n">e</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;coincidence-2&#34;</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">e</span> <span class="ow">&lt;-</span> <span class="n">events1</span>
</span></span><span class="line"><span class="cl">      <span class="n">pure</span> <span class="o">$</span> <span class="n">coincidence</span> <span class="o">$</span> <span class="n">flip</span> <span class="n">mapMoment</span> <span class="n">e</span> <span class="o">$</span>
</span></span><span class="line"><span class="cl">        <span class="n">const</span> <span class="o">$</span> <span class="n">pure</span> <span class="p">(</span><span class="n">deep</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;coincidence-3&#34;</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">e</span> <span class="ow">&lt;-</span> <span class="n">events1</span>
</span></span><span class="line"><span class="cl">      <span class="n">pure</span> <span class="o">$</span> <span class="n">coincidence</span> <span class="o">$</span> <span class="n">flip</span> <span class="n">mapMoment</span> <span class="n">e</span> <span class="o">$</span>
</span></span><span class="line"><span class="cl">        <span class="n">const</span> <span class="o">$</span> <span class="n">pure</span> <span class="p">(</span><span class="n">coincidence</span> <span class="p">(</span><span class="n">e</span> <span class="o">&lt;$</span> <span class="n">e</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;coincidence-4&#34;</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">e</span> <span class="ow">&lt;-</span> <span class="n">events1</span>
</span></span><span class="line"><span class="cl">      <span class="n">pure</span> <span class="o">$</span> <span class="n">coincidence</span> <span class="o">$</span> <span class="n">flip</span> <span class="n">mapMoment</span> <span class="n">e</span> <span class="o">$</span>
</span></span><span class="line"><span class="cl">        <span class="n">const</span> <span class="p">(</span><span class="n">headE</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;coincidence-5&#34;</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">e</span> <span class="ow">&lt;-</span> <span class="n">events1</span>
</span></span><span class="line"><span class="cl">      <span class="n">pure</span> <span class="o">$</span> <span class="n">coincidence</span> <span class="o">$</span> <span class="n">flip</span> <span class="n">mapMoment</span> <span class="n">e</span> <span class="o">$</span> <span class="n">const</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">        <span class="kr">let</span> <span class="n">e&#39;</span> <span class="ow">=</span> <span class="n">deep</span> <span class="n">e</span>
</span></span><span class="line"><span class="cl">        <span class="n">pure</span> <span class="p">(</span><span class="n">coincidence</span> <span class="p">(</span><span class="n">e&#39;</span> <span class="o">&lt;$</span> <span class="n">e&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;coincidence-6&#34;</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">e</span> <span class="ow">&lt;-</span> <span class="n">events1</span>
</span></span><span class="line"><span class="cl">      <span class="n">pure</span> <span class="o">$</span> <span class="n">coincidence</span> <span class="o">$</span> <span class="n">flip</span> <span class="n">mapMoment</span> <span class="n">e</span> <span class="o">$</span> <span class="n">const</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">        <span class="kr">let</span> <span class="n">e&#39;</span> <span class="ow">=</span> <span class="n">coincidence</span> <span class="p">(</span><span class="n">e</span> <span class="o">&lt;$</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">pure</span> <span class="o">$</span> <span class="n">deep</span> <span class="n">e&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;coincidence-7&#34;</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">e</span> <span class="ow">&lt;-</span> <span class="n">events1</span>
</span></span><span class="line"><span class="cl">      <span class="n">pure</span> <span class="o">$</span> <span class="n">coincidence</span> <span class="p">(</span><span class="n">deep</span> <span class="n">e</span> <span class="o">&lt;$</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testB</span> <span class="s">&#34;holdWhileFiring&#34;</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">e</span> <span class="ow">&lt;-</span> <span class="n">events1</span>
</span></span><span class="line"><span class="cl">      <span class="n">liftPlan</span> <span class="o">$</span>  <span class="kr">do</span>
</span></span><span class="line"><span class="cl">        <span class="n">eo</span> <span class="ow">&lt;-</span> <span class="n">headE</span> <span class="n">e</span>
</span></span><span class="line"><span class="cl">        <span class="n">bb</span> <span class="ow">&lt;-</span> <span class="n">hold</span> <span class="p">(</span><span class="n">pure</span> <span class="s">&#34;x&#34;</span><span class="p">)</span> <span class="o">$</span> <span class="n">mapMoment</span> <span class="p">(</span><span class="n">const</span> <span class="o">$</span> <span class="n">hold</span> <span class="s">&#34;a&#34;</span> <span class="n">eo</span><span class="p">)</span> <span class="n">eo</span>
</span></span><span class="line"><span class="cl">        <span class="n">pure</span> <span class="o">$</span> <span class="n">join</span> <span class="n">bb</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;joinDyn&#34;</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">e</span> <span class="ow">&lt;-</span> <span class="n">events1</span>
</span></span><span class="line"><span class="cl">      <span class="n">liftPlan</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">        <span class="n">bb</span> <span class="ow">&lt;-</span> <span class="n">hold</span> <span class="s">&#34;b&#34;</span> <span class="n">e</span>
</span></span><span class="line"><span class="cl">        <span class="n">bd</span> <span class="ow">&lt;-</span> <span class="n">hold</span> <span class="n">never</span> <span class="o">.</span> <span class="n">fmap</span> <span class="p">(</span><span class="n">const</span> <span class="n">e</span><span class="p">)</span> <span class="o">=&lt;&lt;</span> <span class="n">headE</span> <span class="n">e</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">eOuter</span> <span class="ow">&lt;-</span> <span class="n">mapMoment</span> <span class="n">sample</span> <span class="o">.</span> <span class="n">fmap</span> <span class="p">(</span><span class="n">const</span> <span class="n">bb</span><span class="p">)</span> <span class="o">&lt;$&gt;</span> <span class="n">headE</span> <span class="n">e</span>
</span></span><span class="line"><span class="cl">        <span class="kr">let</span> <span class="n">eInner</span> <span class="ow">=</span> <span class="n">switch</span> <span class="n">bd</span>
</span></span><span class="line"><span class="cl">        <span class="n">pure</span> <span class="o">$</span> <span class="n">leftmost</span> <span class="p">[</span><span class="n">eOuter</span><span class="p">,</span> <span class="n">eInner</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testB</span> <span class="s">&#34;holdSampleStrictness&#34;</span>  <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">e1</span> <span class="ow">&lt;-</span> <span class="n">events1</span>
</span></span><span class="line"><span class="cl">      <span class="n">liftPlan</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">        <span class="n">rec</span>
</span></span><span class="line"><span class="cl">          <span class="n">a</span> <span class="ow">&lt;-</span> <span class="n">sample</span> <span class="n">b</span>
</span></span><span class="line"><span class="cl">          <span class="n">b&#39;</span> <span class="ow">&lt;-</span> <span class="n">hold</span> <span class="n">a</span> <span class="n">e1</span>
</span></span><span class="line"><span class="cl">          <span class="n">b</span> <span class="ow">&lt;-</span> <span class="n">hold</span> <span class="s">&#34;0&#34;</span> <span class="n">e1</span>
</span></span><span class="line"><span class="cl">          <span class="kr">_</span> <span class="ow">&lt;-</span> <span class="n">sample</span> <span class="n">b&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="n">pure</span> <span class="n">b&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;difference&#34;</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">e1</span> <span class="ow">&lt;-</span> <span class="n">events1</span>
</span></span><span class="line"><span class="cl">      <span class="n">e2</span> <span class="ow">&lt;-</span> <span class="n">events2</span>
</span></span><span class="line"><span class="cl">      <span class="n">pure</span> <span class="o">$</span> <span class="n">e1</span> <span class="p">`</span><span class="n">difference</span> <span class="p">`</span> <span class="n">e2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;lazy-hold&#34;</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="kr">let</span> <span class="n">lazyHold</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">t</span><span class="o">.</span> <span class="p">(</span><span class="kt">Frp</span> <span class="n">t</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="kt">Moment</span> <span class="n">t</span> <span class="p">(</span><span class="kt">Event</span> <span class="n">t</span> <span class="nb">()</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="n">lazyHold</span> <span class="ow">=</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">            <span class="n">rec</span> <span class="o">!</span><span class="n">b</span> <span class="ow">&lt;-</span> <span class="n">hold</span> <span class="n">never</span> <span class="n">e</span>
</span></span><span class="line"><span class="cl">                <span class="kr">let</span> <span class="n">e</span> <span class="ow">=</span> <span class="n">never</span> <span class="o">&lt;$</span> <span class="n">switch</span> <span class="n">b</span>
</span></span><span class="line"><span class="cl">            <span class="n">pure</span> <span class="o">$</span> <span class="n">void</span> <span class="n">e</span>
</span></span><span class="line"><span class="cl">      <span class="n">liftPlan</span> <span class="n">lazyHold</span>
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;now-1&#34;</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">e1</span> <span class="ow">&lt;-</span> <span class="n">events1</span>
</span></span><span class="line"><span class="cl">      <span class="n">liftPlan</span> <span class="o">$</span> <span class="n">switchHoldPromptly</span> <span class="n">never</span> <span class="o">.</span> <span class="n">mapMoment</span> <span class="p">(</span><span class="nf">\</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">fmap</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;$</span><span class="p">)</span> <span class="n">now</span><span class="p">)</span> <span class="o">$</span> <span class="n">e1</span>
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;now-2&#34;</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">e1</span> <span class="ow">&lt;-</span> <span class="n">events1</span>
</span></span><span class="line"><span class="cl">      <span class="kr">let</span> <span class="n">e</span> <span class="ow">=</span> <span class="n">mapMoment</span> <span class="p">(</span><span class="nf">\</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="kr">if</span> <span class="n">a</span> <span class="o">==</span> <span class="s">&#34;a&#34;</span> <span class="kr">then</span> <span class="n">now</span> <span class="kr">else</span> <span class="n">pure</span> <span class="n">never</span><span class="p">)</span> <span class="n">e1</span>
</span></span><span class="line"><span class="cl">      <span class="n">x</span> <span class="ow">&lt;-</span> <span class="n">liftPlan</span> <span class="o">$</span> <span class="n">accumE</span> <span class="p">(</span><span class="o">&lt;&gt;</span><span class="p">)</span> <span class="n">never</span> <span class="n">e</span>
</span></span><span class="line"><span class="cl">      <span class="n">pure</span> <span class="o">.</span> <span class="n">coincidence</span> <span class="o">$</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;now-3&#34;</span> <span class="o">$</span> <span class="n">liftPlan</span> <span class="n">now</span>
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">testE</span> <span class="s">&#34;now-4&#34;</span> <span class="o">$</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">      <span class="n">coincidence</span> <span class="o">.</span> <span class="n">mapMoment</span> <span class="p">(</span><span class="nf">\</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="kr">if</span> <span class="n">a</span> <span class="o">==</span> <span class="s">&#34;a&#34;</span> <span class="kr">then</span> <span class="n">now</span> <span class="kr">else</span> <span class="n">pure</span> <span class="n">never</span><span class="p">)</span> <span class="o">&lt;$&gt;</span> <span class="n">events1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">]</span>  <span class="kr">where</span>
</span></span><span class="line"><span class="cl">    <span class="n">events1</span><span class="p">,</span> <span class="n">events2</span><span class="p">,</span> <span class="n">events3</span> <span class="ow">::</span>  <span class="kt">TestPlan</span> <span class="n">t</span> <span class="n">m</span> <span class="ow">=&gt;</span> <span class="n">m</span> <span class="p">(</span><span class="kt">Event</span> <span class="n">t</span> <span class="kt">String</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">events1</span> <span class="ow">=</span> <span class="n">plan</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#34;a&#34;</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&#34;b&#34;</span><span class="p">),</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&#34;c&#34;</span><span class="p">),</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&#34;d&#34;</span><span class="p">),</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&#34;e&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="n">events2</span> <span class="ow">=</span> <span class="n">plan</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#34;e&#34;</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&#34;d&#34;</span><span class="p">),</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&#34;c&#34;</span><span class="p">),</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&#34;b&#34;</span><span class="p">),</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&#34;a&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="n">events3</span> <span class="ow">=</span> <span class="n">liftA2</span> <span class="n">mappend</span> <span class="n">events1</span> <span class="n">events2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">behavior1</span><span class="p">,</span> <span class="n">behavior2</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">t</span> <span class="n">m</span><span class="o">.</span> <span class="kt">TestPlan</span> <span class="n">t</span> <span class="n">m</span> <span class="ow">=&gt;</span> <span class="n">m</span> <span class="p">(</span><span class="kt">Behavior</span> <span class="n">t</span> <span class="kt">String</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">behavior1</span> <span class="ow">=</span>  <span class="n">liftPlan</span> <span class="o">.</span> <span class="n">hold</span> <span class="s">&#34;1&#34;</span> <span class="o">=&lt;&lt;</span> <span class="n">events1</span>
</span></span><span class="line"><span class="cl">    <span class="n">behavior2</span> <span class="ow">=</span>  <span class="n">liftPlan</span> <span class="o">.</span> <span class="n">hold</span> <span class="s">&#34;2&#34;</span> <span class="o">=&lt;&lt;</span> <span class="n">events2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">deep</span> <span class="n">e</span> <span class="ow">=</span> <span class="n">leftmost</span> <span class="p">[</span><span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">leftmost2</span> <span class="n">e1</span> <span class="n">e2</span> <span class="ow">=</span> <span class="n">leftmost</span> <span class="p">[</span><span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">]</span>
</span></span></code></pre></div>
</article>
<nav class="no-print post-nav">


</nav>





		        <hr class="bottom-sep" />
		</main>
		<footer class="container no-print">
			<div class="u-footer">
				
<a href="https://github.com/parenthetical"><img class="icon-zocial" src="/img/github.svg" alt="Github"/></a>
<a href="https://twitter.com/aidylns"><img class="icon-zocial" src="/img/twitter.svg" alt="Twitter"/></a>
<a href="https://aidy.dev/index.xml" target="_blank"><img class="icon-zocial" src="/img/feed.svg" alt="Feed"></a>

			</div>
		</footer>
		
   </body>
<script type="text/javascript"
  src="/tex-mml-chtml.js">
</script>
</html>

